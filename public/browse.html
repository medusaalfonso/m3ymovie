<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…ÙƒØªØ¨Ø© | Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª</title>
  <meta name="description" content="Ù…ÙƒØªØ¨Ø© Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© Ø¯Ø§ÙƒÙ†Ø©" />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1626;
      --card2:#121c30;
      --text:#e7ecff;
      --muted:#a8b2d1;
      --border:rgba(255,255,255,.08);
      --accent:#7c5cff;
      --accent2:#22c55e;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% 10%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      direction: rtl;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1150px;margin:0 auto;padding:22px}
    .nav{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 18px;border:1px solid var(--border);
      background:rgba(15,22,38,.7);backdrop-filter: blur(10px);
      border-radius:16px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,197,94,.75));
      box-shadow: 0 12px 40px rgba(124,92,255,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.7);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color: rgba(124,92,255,.45)}
    .btn.primary{background:rgba(124,92,255,.22);border-color: rgba(124,92,255,.35)}
    .btn.ghost{background:transparent}

    .hero{
      margin-top:18px;
      padding:18px;border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.65), rgba(15,22,38,.65));
    }
    .hero h2{margin:0 0 8px;font-size:22px}
    .hero p{margin:0;color:var(--muted);line-height:1.7}

    .tabs{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
    .tab{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.6);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{border-color: rgba(124,92,255,.45);background: rgba(124,92,255,.14)}

    .searchRow{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .searchRow input{
      flex:1;min-width:240px;
      padding:12px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.6);
      color:var(--text);
      outline:none;
    }
    .searchRow input::placeholder{color:rgba(168,178,209,.7)}

    .grid{
      margin-top:16px;
      display:grid;gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    }
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.8), rgba(15,22,38,.85));
      border-radius:16px;overflow:hidden;
      box-shadow: 0 14px 50px rgba(0,0,0,.28);
      display:flex;flex-direction:column;
      min-height: 100%;
    }
    .poster{aspect-ratio: 2/3;background: rgba(255,255,255,.05)}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px;display:flex;flex-direction:column;gap:10px}
    .meta h3{margin:0;font-size:14px;line-height:1.4}
    .small{color:var(--muted);font-size:12px;line-height:1.6}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;border-radius:999px;
      width:fit-content;
    }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.65);
      border-radius:16px;
      padding:14px;
    }
    .panelHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHeader h3{margin:0;font-size:16px}
    .episodes{
      display:flex;flex-direction:column;gap:10px;
      margin-top:10px;
    }
    .epBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.55);
      color:var(--text);
      cursor:pointer;
      text-align:right;
    }
    .epBtn:hover{border-color: rgba(124,92,255,.45)}
    .footerNote{margin-top:18px;color:rgba(168,178,209,.75);font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ù…ÙƒØªØ¨ØªÙŠ</h1>
          <p>Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ©</p>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <!-- Optional: link to your Telegram bot -->
        <a class="btn" id="botLink" href="#" target="_blank" rel="noopener">ğŸ¤– Ø§Ù„Ø¨ÙˆØª</a>
        <a class="btn primary" href="/index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>

    <div class="hero">
      <h2>Ø§Ø®ØªØ± Ø´ÙŠØ¦Ù‹Ø§ Ù„ØªØ´Ø§Ù‡Ø¯Ù‡ ğŸ¿</h2>
      <p>
        ØªØµÙÙ‘Ø­ <b>Ø§Ù„Ø£ÙÙ„Ø§Ù…</b> Ùˆ<b>Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</b> Ùˆ<b>Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©</b>.
        Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ù„Ù„ÙˆØµÙˆÙ„ Ø¨Ø³Ø±Ø¹Ø© Ù„Ø£ÙŠ Ø¹Ù†ÙˆØ§Ù†.
      </p>

      <div class="tabs">
        <button class="tab active" id="tab-films" onclick="setTab('films')">Ø§Ù„Ø£ÙÙ„Ø§Ù…</button>
        <button class="tab" id="tab-series" onclick="setTab('series')">Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</button>
        <button class="tab" id="tab-foreign" onclick="setTab('foreign')">Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</button>
      </div>

      <div class="searchRow">
        <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." oninput="applySearch()" />
        <button class="btn" onclick="refreshCurrent()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <!-- Main content -->
    <div id="content" class="grid"></div>

    <div class="footerNote">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· m3u8 Ù„Ø§ ÙŠØ¹Ù…Ù„ØŒ ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (CORS/Token/Geo). Ø¬Ø±Ù‘Ø¨ Ù…ØµØ¯Ø± Ø¢Ø®Ø±.
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // Put your bot username here (without @) if you want the "Bot" button to work.
    const TELEGRAM_BOT_USERNAME = ""; // e.g. "YourBotName"

    const API = {
      films: "/.netlify/functions/catalog",
      series: "/.netlify/functions/series",
      foreign: "/.netlify/functions/foreignSeries"
    };

    // ====== STATE ======
    let currentTab = "films";
    let filmsCache = [];
    let seriesCache = [];
    let foreignCache = [];

    // ====== INIT ======
    (function init(){
      const botLink = document.getElementById("botLink");
      if (TELEGRAM_BOT_USERNAME) {
        botLink.href = "https://t.me/" + TELEGRAM_BOT_USERNAME;
      } else {
        botLink.href = "#";
        botLink.onclick = (e) => {
          e.preventDefault();
          alert("Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª ÙÙŠ browse.html Ø¯Ø§Ø®Ù„ TELEGRAM_BOT_USERNAME");
        };
      }

      // Load default tab
      loadFilms();
    })();

    // ====== UI helpers ======
    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById(`tab-${tab}`);
      if (btn) btn.classList.add("active");
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalize(s){
      return String(s || "").toLowerCase().trim();
    }

    function getQuery(){
      return normalize(document.getElementById("q").value);
    }

    function showLoading(msg){
      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="small">${escapeHtml(msg)}</div>
        </div>
      `;
    }

    function showGrid(){
      const el = document.getElementById("content");
      el.className = "grid";
    }

    // ====== TAB CONTROL ======
    function setTab(tab){
      currentTab = tab;
      setActiveTab(tab);
      document.getElementById("q").value = "";

      if (tab === "films") return loadFilms();
      if (tab === "series") return loadSeries();
      if (tab === "foreign") return loadForeignSeries();
    }

    function refreshCurrent(){
      if (currentTab === "films") return loadFilms(true);
      if (currentTab === "series") return loadSeries(true);
      if (currentTab === "foreign") return loadForeignSeries(true);
    }

    function applySearch(){
      const q = getQuery();

      if (currentTab === "films"){
        const filtered = q ? filmsCache.filter(x => normalize(x.title).includes(q)) : filmsCache;
        return renderFilms(filtered);
      }
      if (currentTab === "series"){
        const filtered = q ? seriesCache.filter(x => normalize(x.title).includes(q) || normalize(x.genre).includes(q)) : seriesCache;
        return renderSeriesList(filtered);
      }
      if (currentTab === "foreign"){
        const filtered = q ? foreignCache.filter(x => normalize(x.title).includes(q)) : foreignCache;
        return renderForeignSeriesList(filtered);
      }
    }

    // ====== LOADERS ======
    async function loadFilms(force){
      setActiveTab("films");
      showLoading("... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙÙ„Ø§Ù…");
      try{
        const res = await fetch(API.films + (force ? `?t=${Date.now()}` : ""));
        const data = await res.json();
        filmsCache = Array.isArray(data) ? data : [];
        renderFilms(filmsCache);
      } catch(e){
        showError("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙÙ„Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Function catalog.js");
      }
    }

    async function loadSeries(force){
      setActiveTab("series");
      showLoading("... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª");
      try{
        const res = await fetch(API.series + (force ? `?t=${Date.now()}` : ""));
        const data = await res.json();
        seriesCache = Array.isArray(data) ? data : [];
        renderSeriesList(seriesCache);
      } catch(e){
        showError("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Function series.js");
      }
    }

    async function loadForeignSeries(force){
      setActiveTab("foreign");
      showLoading("... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©");
      try{
        const res = await fetch(API.foreign + (force ? `?t=${Date.now()}` : ""));
        const data = await res.json();
        foreignCache = Array.isArray(data) ? data : [];
        renderForeignSeriesList(foreignCache);
      } catch(e){
        showError("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©. ØªØ£ÙƒØ¯ Ù…Ù† Function foreignSeries.js");
      }
    }

    function showError(msg){
      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="small" style="color:#ffb4b4">âš  ${escapeHtml(msg)}</div>
          <div class="small">Ø§ÙØªØ­ Console Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„.</div>
        </div>
      `;
      console.error(msg);
    }

    // ====== RENDER FILMS ======
    function renderFilms(list){
      showGrid();
      const el = document.getElementById("content");
      el.innerHTML = "";

      if (!list.length){
        el.innerHTML = `<div class="panel" style="width:100%"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div></div>`;
        return;
      }

      list.forEach(item => {
        const title = item.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const url = item.url || "";
        const image = item.image || "https://via.placeholder.com/600x900?text=Poster";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="poster">
            <img loading="lazy" src="${escapeHtml(image)}" alt="${escapeHtml(title)}">
          </div>
          <div class="meta">
            <h3>${escapeHtml(title)}</h3>
            <div class="badge">ğŸ¬ ÙÙŠÙ„Ù…</div>
            <button class="btn primary" onclick="openFilm('${encodeURIComponent(title)}','${encodeURIComponent(url)}')">Ù…Ø´Ø§Ù‡Ø¯Ø©</button>
          </div>
        `;

        el.appendChild(card);
      });
    }

    function openFilm(titleEnc, urlEnc){
      const title = decodeURIComponent(titleEnc);
      const url = decodeURIComponent(urlEnc);
      const params = new URLSearchParams();
      params.set("type", "film");
      params.set("title", title);
      params.set("src", url);
      window.location.href = "/watch.html?" + params.toString();
    }

    // ====== RENDER ARABIC SERIES ======
    function renderSeriesList(list){
      showGrid();
      const el = document.getElementById("content");
      el.innerHTML = "";

      if (!list.length){
        el.innerHTML = `<div class="panel" style="width:100%"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div></div>`;
        return;
      }

      // group by genre (optional)
      // we will just show badges if genre exists
      list.forEach(series => {
        const title = series.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const image = series.image || "https://via.placeholder.com/600x900?text=Poster";
        const genre = series.genre || "";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="poster">
            <img loading="lazy" src="${escapeHtml(image)}" alt="${escapeHtml(title)}">
          </div>
          <div class="meta">
            <h3>${escapeHtml(title)}</h3>
            <div class="badge">ğŸ“º Ù…Ø³Ù„Ø³Ù„${genre ? " â€¢ " + escapeHtml(genre) : ""}</div>
            <div class="small">${(series.episodes || []).length} Ø­Ù„Ù‚Ø©</div>
            <button class="btn primary" onclick="openSeries('${encodeURIComponent(title)}')">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    function openSeries(seriesTitleEnc){
      const seriesTitle = decodeURIComponent(seriesTitleEnc);
      const series = seriesCache.find(s => s.title === seriesTitle);
      if (!series) return;

      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="panelHeader">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn ghost" onclick="renderSeriesList(seriesCache)">â¬… Ø±Ø¬ÙˆØ¹</button>
              <h3>${escapeHtml(series.title)}</h3>
              ${series.genre ? `<span class="badge">${escapeHtml(series.genre)}</span>` : ""}
            </div>
            <div class="small">${(series.episodes || []).length} Ø­Ù„Ù‚Ø©</div>
          </div>
          <div class="episodes" id="episodes"></div>
        </div>
      `;

      const eps = document.getElementById("episodes");
      (series.episodes || []).forEach((ep, idx) => {
        const btn = document.createElement("button");
        btn.className = "epBtn";
        btn.innerHTML = `<span>${escapeHtml(ep.title || `Episode ${idx+1}`)}</span><span class="small">â–¶</span>`;
        btn.onclick = () => {
          const params = new URLSearchParams();
          params.set("type","series-ep");
          params.set("series", series.title);
          params.set("ep", ep.title || `Episode ${idx+1}`);
          params.set("src", ep.hlsUrl);
          window.location.href = "/watch.html?" + params.toString();
        };
        eps.appendChild(btn);
      });
    }

    // ====== RENDER FOREIGN SERIES (HLS + VTT) ======
    function renderForeignSeriesList(list){
      showGrid();
      const el = document.getElementById("content");
      el.innerHTML = "";

      if (!list.length){
        el.innerHTML = `<div class="panel" style="width:100%"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div></div>`;
        return;
      }

      list.forEach(series => {
        const title = series.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const image = series.image || "https://via.placeholder.com/600x900?text=Poster";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="poster">
            <img loading="lazy" src="${escapeHtml(image)}" alt="${escapeHtml(title)}">
          </div>
          <div class="meta">
            <h3>${escapeHtml(title)}</h3>
            <div class="badge">ğŸŒ Ù…Ø³Ù„Ø³Ù„ Ø£Ø¬Ù†Ø¨ÙŠ</div>
            <div class="small">${(series.episodes || []).length} Ø­Ù„Ù‚Ø©</div>
            <button class="btn primary" onclick="openForeignSeries('${encodeURIComponent(title)}')">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    function openForeignSeries(seriesTitleEnc){
      const seriesTitle = decodeURIComponent(seriesTitleEnc);
      const series = foreignCache.find(s => s.title === seriesTitle);
      if (!series) return;

      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="panelHeader">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn ghost" onclick="renderForeignSeriesList(foreignCache)">â¬… Ø±Ø¬ÙˆØ¹</button>
              <h3>${escapeHtml(series.title)}</h3>
              <span class="badge">ğŸŒ</span>
            </div>
            <div class="small">${(series.episodes || []).length} Ø­Ù„Ù‚Ø©</div>
          </div>
          <div class="episodes" id="episodes"></div>
        </div>
      `;

      const eps = document.getElementById("episodes");
      (series.episodes || []).forEach((ep, idx) => {
        const btn = document.createElement("button");
        btn.className = "epBtn";

        const subsCount = (ep.subs || []).length;
        const subsTxt = subsCount ? ` â€¢ ØªØ±Ø¬Ù…Ø§Øª: ${subsCount}` : "";

        btn.innerHTML = `<span>${escapeHtml(ep.title || `Episode ${idx+1}`)}<span class="small">${escapeHtml(subsTxt)}</span></span><span class="small">â–¶</span>`;

        btn.onclick = () => {
          // send the whole episode object encoded safely
          const payload = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(ep)))));
          const params = new URLSearchParams();
          params.set("type", "foreign-ep");
          params.set("series", series.title);
          params.set("ep", ep.title || `Episode ${idx+1}`);
          params.set("payload", payload);
          window.location.href = "/watch.html?" + params.toString();
        };

        eps.appendChild(btn);
      });
    }
  </script>
</body>
</html>
