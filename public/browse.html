<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…ÙƒØªØ¨Ø©</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1626;
      --card2:#121c30;
      --text:#e7ecff;
      --muted:#a8b2d1;
      --border:rgba(255,255,255,.08);
      --accent:#7c5cff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% 10%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      direction: rtl;
    }
    .container{max-width:1150px;margin:0 auto;padding:22px}

    .nav{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 18px;border:1px solid var(--border);
      background:rgba(15,22,38,.7);backdrop-filter: blur(10px);
      border-radius:16px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,197,94,.75));
      box-shadow: 0 12px 40px rgba(124,92,255,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;color:var(--muted);font-size:12px}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.7);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{border-color: rgba(124,92,255,.45)}
    .btn.primary{background:rgba(124,92,255,.22);border-color: rgba(124,92,255,.35)}

    .hero{
      margin-top:18px;
      padding:18px;border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.65), rgba(15,22,38,.65));
    }
    .hero h2{margin:0 0 8px;font-size:22px}
    .hero p{margin:0;color:var(--muted);line-height:1.7}

    .tabs{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .tab{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.6);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{border-color: rgba(124,92,255,.45);background: rgba(124,92,255,.14)}

    .pills{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .pill.active{border-color: rgba(124,92,255,.45);background: rgba(124,92,255,.14)}

    .searchRow{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .searchRow input{
      flex:1;min-width:240px;
      padding:12px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.6);
      color:var(--text);
      outline:none;
    }
    .searchRow input::placeholder{color:rgba(168,178,209,.7)}

    .grid{
      margin-top:16px;
      display:grid;gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    }
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.8), rgba(15,22,38,.85));
      border-radius:16px;overflow:hidden;
      box-shadow: 0 14px 50px rgba(0,0,0,.28);
      display:flex;flex-direction:column;
    }
    .poster{aspect-ratio: 2/3;background: rgba(255,255,255,.05)}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px;display:flex;flex-direction:column;gap:10px}
    .meta h3{margin:0;font-size:14px;line-height:1.4}
    .small{color:var(--muted);font-size:12px;line-height:1.6}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;border-radius:999px;
      width:fit-content;
    }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.65);
      border-radius:16px;
      padding:14px;
    }
    .panelHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHeader h3{margin:0;font-size:16px}
    .episodes{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .epBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.55);
      color:var(--text);
      cursor:pointer;
      text-align:right;
    }
    .epBtn:hover{border-color: rgba(124,92,255,.45)}

    .debug{
      margin-top:12px;
      border:1px dashed rgba(255,255,255,.15);
      background: rgba(0,0,0,.25);
      border-radius:14px;
      padding:12px;
      color: rgba(231,236,255,.9);
      display:none;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ù…ÙƒØªØ¨ØªÙŠ</h1>
          <p>Ø£ÙÙ„Ø§Ù… â€¢ Ù…Ø³Ù„Ø³Ù„Ø§Øª â€¢ Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</p>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn primary" href="/index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>

    <div class="hero">
      <h2>Ø§Ø®ØªØ± Ø´ÙŠØ¦Ù‹Ø§ Ù„ØªØ´Ø§Ù‡Ø¯Ù‡ ğŸ¿</h2>
      <p>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† catalog.</p>

      <div class="tabs">
        <button class="tab active" id="tab-films" onclick="setTab('films')">Ø§Ù„Ø£ÙÙ„Ø§Ù…</button>
        <button class="tab" id="tab-series" onclick="setTab('series')">Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</button>
        <button class="tab" id="tab-foreign" onclick="setTab('foreign')">Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</button>
      </div>

      <div class="pills" id="filmPills"></div>

      <div class="searchRow">
        <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." oninput="applySearch()" />
        <button class="btn" onclick="init()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <div id="debug" class="debug"></div>
    </div>

    <div id="content" class="grid"></div>
  </div>

  <script>
    const CATALOG_URL = "/.netlify/functions/catalog";
    const FOREIGN_URL  = "/.netlify/functions/foreignSeries"; // optional
    const PLACEHOLDER  = "https://via.placeholder.com/600x900?text=Poster";

    let currentTab = "films";
    let catalogItems = [];
    let films = [];
    let seriesMap = new Map();

    // film categories (Ù…Ø«Ù„: Ø£ÙÙ„Ø§Ù… ØªÙˆÙ†Ø³ÙŠØ©)
    let filmCategories = ["Ø§Ù„ÙƒÙ„"];
    let activeFilmCategory = "Ø§Ù„ÙƒÙ„";

    // foreign series (optional)
    let foreignSeries = []; // array of { title, image, episodes:[{title,url,sub?}] }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function norm(s){ return String(s ?? "").toLowerCase().trim(); }

    function setDebug(text){
      const el = document.getElementById("debug");
      if (!text){
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.style.display = "block";
      el.textContent = text;
    }

    function setActiveTabUI(tab){
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById(`tab-${tab}`);
      if (btn) btn.classList.add("active");
    }

    function withBuster(url){
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "t=" + Date.now();
    }

    // ---- Load catalog (films + series episodes) ----
    async function fetchCatalog(){
      const res = await fetch(withBuster(CATALOG_URL));
      if (!res.ok) throw new Error(`catalog HTTP ${res.status}`);
      const data = await res.json();

      // handle multiple shapes safely
      let items = [];
      if (Array.isArray(data)) items = data;
      else if (Array.isArray(data.items)) items = data.items;
      else if (Array.isArray(data.data)) items = data.data;
      else if (Array.isArray(data.movies) || Array.isArray(data.series)) {
        items = []
          .concat(Array.isArray(data.movies) ? data.movies : [])
          .concat(Array.isArray(data.series) ? data.series : []);
      } else {
        // last resort: try to find an array inside object
        for (const k of Object.keys(data || {})){
          if (Array.isArray(data[k])) { items = data[k]; break; }
        }
      }

      return items;
    }

    // Derive film category from any common field names
    function getFilmCategory(it){
      const c =
        it.category ??
        it.cat ??
        it.section ??
        it.group ??
        it.typeCategory ??
        "";
      const val = String(c || "").trim();
      return val || "Ø£ÙÙ„Ø§Ù…";
    }

    // Build indexes from catalog
    function buildFromCatalog(items){
      catalogItems = items;
      films = [];
      seriesMap = new Map();

      const catSet = new Set();

      for (const it of items){
        if (!it || typeof it !== "object") continue;

        // FILM: has title, does NOT have seriesTitle
        if (it.title && !it.seriesTitle){
          const title = String(it.title).trim();
          const url = it.url || it.m3u8 || it.src || it.link || "";
          const image = it.image || it.poster || it.cover || PLACEHOLDER;
          const category = getFilmCategory(it);

          if (title && url){
            films.push({ title, url, image, category });
            catSet.add(category);
          }
          continue;
        }

        // SERIES EP: has seriesTitle
        if (it.seriesTitle){
          const st = String(it.seriesTitle).trim();
          const epTitle = String(it.ep || it.episode || it.epTitle || "Ø­Ù„Ù‚Ø©").trim();
          const epUrl = it.url || it.m3u8 || it.src || it.hlsUrl || it.link || "";
          const image = it.image || it.poster || it.cover || PLACEHOLDER;
          const genre = it.genre || "";

          if (!st || !epUrl) continue;

          if (!seriesMap.has(st)){
            seriesMap.set(st, { title: st, image, genre, episodes: [] });
          }
          const s = seriesMap.get(st);

          if ((s.image === PLACEHOLDER) && image && image !== PLACEHOLDER) s.image = image;
          if (!s.genre && genre) s.genre = genre;

          s.episodes.push({ title: epTitle, url: epUrl });
        }
      }

      filmCategories = ["Ø§Ù„ÙƒÙ„", ...Array.from(catSet).sort((a,b)=>a.localeCompare(b,"ar"))];
      if (!filmCategories.includes(activeFilmCategory)) activeFilmCategory = "Ø§Ù„ÙƒÙ„";
    }

    // ---- Optional: foreign series endpoint ----
    async function fetchForeign(){
      try{
        const res = await fetch(withBuster(FOREIGN_URL));
        if (!res.ok) throw new Error(`foreign HTTP ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("foreign response is not an array");
        foreignSeries = data;
      }catch(e){
        foreignSeries = [];
        // donâ€™t break the whole page
        setDebug((document.getElementById("debug").textContent || "") +
          `\n[foreign] ${e.message}`);
      }
    }

    // ---- UI: pills ----
    function renderFilmPills(){
      const wrap = document.getElementById("filmPills");
      wrap.innerHTML = "";

      // show pills only for Films tab
      wrap.style.display = (currentTab === "films") ? "flex" : "none";

      filmCategories.forEach(cat => {
        const b = document.createElement("button");
        b.className = "pill" + (cat === activeFilmCategory ? " active" : "");
        b.textContent = cat;
        b.onclick = () => {
          activeFilmCategory = cat;
          renderFilmPills();
          applySearch();
        };
        wrap.appendChild(b);
      });
    }

    // ---- Render films grid ----
    function renderFilms(list){
      const el = document.getElementById("content");
      el.className = "grid";
      el.innerHTML = "";

      if (!list.length){
        el.innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙÙ„Ø§Ù… Ù‡Ù†Ø§.</div></div>`;
        return;
      }

      list.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="poster"><img loading="lazy" src="${esc(item.image)}" alt="${esc(item.title)}"></div>
          <div class="meta">
            <h3>${esc(item.title)}</h3>
            <div class="badge">ğŸ¬ ${esc(item.category)}</div>
            <button class="btn primary" onclick="openWatch('film','${encodeURIComponent(item.title)}','${encodeURIComponent(item.url)}')">Ù…Ø´Ø§Ù‡Ø¯Ø©</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    // ---- Render series cards ----
    function renderSeriesCards(arr){
      const el = document.getElementById("content");
      el.className = "grid";
      el.innerHTML = "";

      if (!arr.length){
        el.innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ù„Ø³Ù„Ø§Øª.</div></div>`;
        return;
      }

      arr.forEach(series => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="poster"><img loading="lazy" src="${esc(series.image)}" alt="${esc(series.title)}"></div>
          <div class="meta">
            <h3>${esc(series.title)}</h3>
            <div class="badge">ğŸ“º Ù…Ø³Ù„Ø³Ù„${series.genre ? " â€¢ " + esc(series.genre) : ""}</div>
            <div class="small">${series.episodes.length} Ø­Ù„Ù‚Ø©</div>
            <button class="btn primary" onclick="openSeries('${encodeURIComponent(series.title)}')">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    // ---- Render foreign series cards ----
    function renderForeignCards(arr){
      const el = document.getElementById("content");
      el.className = "grid";
      el.innerHTML = "";

      if (!arr.length){
        el.innerHTML = `<div class="panel" style="grid-column:1/-1">
          <div class="small">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ endpoint Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡Ø§.<br>
            ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¹Ù…Ù„: <span style="opacity:.85">/.netlify/functions/foreignSeries</span>
          </div>
        </div>`;
        return;
      }

      arr.forEach(series => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="poster"><img loading="lazy" src="${esc(series.image || PLACEHOLDER)}" alt="${esc(series.title)}"></div>
          <div class="meta">
            <h3>${esc(series.title)}</h3>
            <div class="badge">ğŸŒ Ù…Ø³Ù„Ø³Ù„ Ø£Ø¬Ù†Ø¨ÙŠ</div>
            <div class="small">${(series.episodes||[]).length} Ø­Ù„Ù‚Ø©</div>
            <button class="btn primary" onclick="openForeignSeries('${encodeURIComponent(series.title)}')">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    // ---- Open series episodes view ----
    function openSeries(seriesTitleEnc){
      const title = decodeURIComponent(seriesTitleEnc);
      const series = seriesMap.get(title);
      if (!series) return;

      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="panelHeader">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" onclick="applySearch()">â¬… Ø±Ø¬ÙˆØ¹</button>
              <h3>${esc(series.title)}</h3>
              ${series.genre ? `<span class="badge">${esc(series.genre)}</span>` : ""}
            </div>
            <div class="small">${series.episodes.length} Ø­Ù„Ù‚Ø©</div>
          </div>
          <div class="episodes" id="episodes"></div>
        </div>
      `;

      const eps = document.getElementById("episodes");
      series.episodes.forEach((ep, idx) => {
        const btn = document.createElement("button");
        btn.className = "epBtn";
        btn.innerHTML = `<span>${esc(ep.title || `Ø­Ù„Ù‚Ø© ${idx+1}`)}</span><span class="small">â–¶</span>`;
        btn.onclick = () => openWatch("series-ep", encodeURIComponent(series.title), encodeURIComponent(ep.url), encodeURIComponent(ep.title || `Ø­Ù„Ù‚Ø© ${idx+1}`));
        eps.appendChild(btn);
      });
    }

    // ---- Foreign episodes (optional) ----
    function openForeignSeries(seriesTitleEnc){
      const title = decodeURIComponent(seriesTitleEnc);
      const series = (foreignSeries || []).find(s => s.title === title);
      if (!series) return;

      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="panelHeader">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" onclick="applySearch()">â¬… Ø±Ø¬ÙˆØ¹</button>
              <h3>${esc(series.title)}</h3>
              <span class="badge">ğŸŒ Ø£Ø¬Ù†Ø¨ÙŠ</span>
            </div>
            <div class="small">${(series.episodes||[]).length} Ø­Ù„Ù‚Ø©</div>
          </div>
          <div class="episodes" id="foreignEpisodes"></div>
        </div>
      `;

      const eps = document.getElementById("foreignEpisodes");
      (series.episodes || []).forEach((ep, idx) => {
        const btn = document.createElement("button");
        btn.className = "epBtn";
        btn.innerHTML = `<span>${esc(ep.title || `Ø­Ù„Ù‚Ø© ${idx+1}`)}</span><span class="small">â–¶</span>`;
        btn.onclick = () => {
          // If you use m3u8 + external vtt, watch.html should handle &sub=...
          // Here we pass src + optional sub
          const src = encodeURIComponent(ep.url || "");
          const sub = encodeURIComponent(ep.sub || "");
          const params = new URLSearchParams();
          params.set("type", "foreign-ep");
          params.set("series", series.title);
          params.set("ep", ep.title || `Ø­Ù„Ù‚Ø© ${idx+1}`);
          params.set("src", decodeURIComponent(src));
          if (ep.sub) params.set("sub", decodeURIComponent(sub));
          window.location.href = "/watch.html?" + params.toString();
        };
        eps.appendChild(btn);
      });
    }

    // ---- Go to watch ----
    function openWatch(type, titleEnc, srcEnc, epEnc){
      const params = new URLSearchParams();
      params.set("type", type);

      const src = decodeURIComponent(srcEnc || "");
      params.set("src", src);

      if (type === "film"){
        params.set("title", decodeURIComponent(titleEnc || ""));
      } else {
        params.set("series", decodeURIComponent(titleEnc || ""));
        params.set("ep", decodeURIComponent(epEnc || ""));
      }

      window.location.href = "/watch.html?" + params.toString();
    }

    // ---- Filtering/search per tab ----
    function applySearch(){
      const q = norm(document.getElementById("q").value);

      if (currentTab === "films"){
        let list = films.slice();

        if (activeFilmCategory !== "Ø§Ù„ÙƒÙ„"){
          list = list.filter(x => x.category === activeFilmCategory);
        }
        if (q){
          list = list.filter(x => norm(x.title).includes(q) || norm(x.category).includes(q));
        }
        renderFilms(list);
        return;
      }

      if (currentTab === "series"){
        let arr = Array.from(seriesMap.values());
        if (q){
          arr = arr.filter(s => norm(s.title).includes(q) || norm(s.genre).includes(q));
        }
        renderSeriesCards(arr);
        return;
      }

      if (currentTab === "foreign"){
        let arr = foreignSeries.slice();
        if (q){
          arr = arr.filter(s => norm(s.title).includes(q));
        }
        renderForeignCards(arr);
        return;
      }
    }

    function setTab(tab){
      currentTab = tab;
      setActiveTabUI(tab);
      document.getElementById("q").value = "";
      renderFilmPills();
      applySearch();
    }

    // ---- Init ----
    async function init(){
      setDebug("");

      try{
        const items = await fetchCatalog();
        buildFromCatalog(items);

        // Optional foreign fetch (wonâ€™t break page)
        await fetchForeign();

        setActiveTabUI(currentTab);
        renderFilmPills();

        // quick debug info (useful when "nothing loads")
        setDebug(
          `loaded catalog items: ${catalogItems.length}\n` +
          `films: ${films.length}\n` +
          `series titles: ${seriesMap.size}\n` +
          `film categories: ${filmCategories.join(" | ")}\n` +
          `foreign series: ${foreignSeries.length}\n` +
          `catalog endpoint: ${CATALOG_URL}`
        );

        applySearch();
      }catch(e){
        setDebug(`ERROR: ${e.message}\nCheck Network tab and open:\n${location.origin}${CATALOG_URL}`);
        document.getElementById("content").innerHTML =
          `<div class="panel" style="grid-column:1/-1">
            <div style="color:#ef4444;font-weight:700">âš  ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</div>
            <div class="small">ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¹Ù…Ù„: <b>/.netlify/functions/catalog</b></div>
           </div>`;
      }
    }

    init();
  </script>
</body>
</html>
