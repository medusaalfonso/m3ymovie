<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…ÙƒØªØ¨Ø©</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1626;
      --card2:#121c30;
      --text:#e7ecff;
      --muted:#a8b2d1;
      --border:rgba(255,255,255,.08);
      --accent:#7c5cff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% 10%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      direction: rtl;
    }
    .container{max-width:1150px;margin:0 auto;padding:22px}
    .nav{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 18px;border:1px solid var(--border);
      background:rgba(15,22,38,.7);backdrop-filter: blur(10px);
      border-radius:16px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,197,94,.75));
      box-shadow: 0 12px 40px rgba(124,92,255,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;color:var(--muted);font-size:12px}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.7);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{border-color: rgba(124,92,255,.45)}
    .btn.primary{background:rgba(124,92,255,.22);border-color: rgba(124,92,255,.35)}

    .hero{
      margin-top:18px;
      padding:18px;border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.65), rgba(15,22,38,.65));
    }
    .hero h2{margin:0 0 8px;font-size:22px}
    .hero p{margin:0;color:var(--muted);line-height:1.7}

    .tabs{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .tab{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.6);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{border-color: rgba(124,92,255,.45);background: rgba(124,92,255,.14)}

    .pills{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .pill.active{border-color: rgba(124,92,255,.45);background: rgba(124,92,255,.14)}

    .searchRow{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .searchRow input{
      flex:1;min-width:240px;
      padding:12px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.6);
      color:var(--text);
      outline:none;
    }
    .searchRow input::placeholder{color:rgba(168,178,209,.7)}

    .grid{
      margin-top:16px;
      display:grid;gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    }
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.8), rgba(15,22,38,.85));
      border-radius:16px;overflow:hidden;
      box-shadow: 0 14px 50px rgba(0,0,0,.28);
      display:flex;flex-direction:column;
    }
    .poster{aspect-ratio: 2/3;background: rgba(255,255,255,.05)}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px;display:flex;flex-direction:column;gap:10px}
    .meta h3{margin:0;font-size:14px;line-height:1.4}
    .small{color:var(--muted);font-size:12px;line-height:1.6}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;border-radius:999px;
      width:fit-content;
    }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.65);
      border-radius:16px;
      padding:14px;
    }
    .panelHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHeader h3{margin:0;font-size:16px}
    .episodes{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .epBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.55);
      color:var(--text);
      cursor:pointer;
      text-align:right;
    }
    .epBtn:hover{border-color: rgba(124,92,255,.45)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ù…ÙƒØªØ¨ØªÙŠ</h1>
          <p>Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª</p>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn primary" href="/index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>

    <div class="hero">
      <h2>Ø§Ø®ØªØ± Ø´ÙŠØ¦Ù‹Ø§ Ù„ØªØ´Ø§Ù‡Ø¯Ù‡ ğŸ¿</h2>
      <p>Ø§Ù„Ø£ÙÙ„Ø§Ù… â€¢ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</p>

      <div class="tabs">
        <button class="tab active" id="tab-films" onclick="setTab('films')">Ø§Ù„Ø£ÙÙ„Ø§Ù…</button>
        <button class="tab" id="tab-series" onclick="setTab('series')">Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</button>
      </div>

      <!-- Film categories pills (restored) -->
      <div class="pills" id="filmPills"></div>

      <div class="searchRow">
        <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." oninput="applySearch()" />
        <button class="btn" onclick="refresh()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <div id="status" class="panel" style="display:none"></div>
    <div id="content" class="grid"></div>
  </div>

  <script>
    const CATALOG_URL = "/.netlify/functions/catalog";
    const PLACEHOLDER = "https://via.placeholder.com/600x900?text=Poster";

    let currentTab = "films";
    let allItems = [];

    let films = [];
    let seriesMap = new Map();

    let filmCategories = ["Ø§Ù„ÙƒÙ„"];   // auto built
    let activeFilmCategory = "Ø§Ù„ÙƒÙ„"; // pill selected

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function normalize(s){ return String(s || "").toLowerCase().trim(); }

    function showStatus(html){
      const box = document.getElementById("status");
      box.style.display = "block";
      box.innerHTML = html;
    }
    function clearStatus(){
      const box = document.getElementById("status");
      box.style.display = "none";
      box.innerHTML = "";
    }
    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById(`tab-${tab}`);
      if (btn) btn.classList.add("active");
    }

    function withBuster(url){
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "t=" + Date.now();
    }

    async function loadCatalog(){
      showStatus(`â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`);
      const res = await fetch(withBuster(CATALOG_URL));
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
      allItems = items;

      buildIndexes(items);
      buildFilmPills();

      showStatus(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø§Ù„Ø¹Ù†Ø§ØµØ±: <b>${items.length}</b>`);
    }

    function buildIndexes(items){
      films = [];
      seriesMap = new Map();

      const catSet = new Set();

      for (const it of items){
        // FILM: title (and no seriesTitle)
        if (it && it.title && !it.seriesTitle){
          const category = (it.category || it.cat || "Ø£ÙÙ„Ø§Ù…").toString().trim() || "Ø£ÙÙ„Ø§Ù…";

          films.push({
            title: it.title,
            url: it.url || it.m3u8 || it.src || "",
            image: it.image || it.poster || PLACEHOLDER,
            category
          });

          catSet.add(category);
          continue;
        }

        // SERIES EP: seriesTitle + ep
        if (it && it.seriesTitle){
          const st = String(it.seriesTitle);
          const epName = it.ep || it.episode || it.epTitle || "";
          const epUrl = it.url || it.hlsUrl || it.m3u8 || it.src || "";

          if (!seriesMap.has(st)){
            seriesMap.set(st, {
              title: st,
              image: it.image || it.poster || PLACEHOLDER,
              genre: it.genre || "",
              episodes: []
            });
          }
          const obj = seriesMap.get(st);

          if (obj.image === PLACEHOLDER && (it.image || it.poster)) obj.image = it.image || it.poster;
          if (it.genre && !obj.genre) obj.genre = it.genre;

          if (epUrl){
            obj.episodes.push({ title: epName || "Ø­Ù„Ù‚Ø©", url: epUrl });
          }
        }
      }

      filmCategories = ["Ø§Ù„ÙƒÙ„", ...Array.from(catSet).sort((a,b)=>a.localeCompare(b, "ar"))];

      // keep active category valid
      if (!filmCategories.includes(activeFilmCategory)) activeFilmCategory = "Ø§Ù„ÙƒÙ„";
    }

    function buildFilmPills(){
      const wrap = document.getElementById("filmPills");
      wrap.innerHTML = "";

      // show pills only in Films tab
      wrap.style.display = (currentTab === "films") ? "flex" : "none";

      filmCategories.forEach(cat => {
        const b = document.createElement("button");
        b.className = "pill" + (cat === activeFilmCategory ? " active" : "");
        b.textContent = cat;
        b.onclick = () => {
          activeFilmCategory = cat;
          buildFilmPills();
          applySearch();
        };
        wrap.appendChild(b);
      });
    }

    function setTab(tab){
      currentTab = tab;
      document.getElementById("q").value = "";
      setActiveTab(tab);
      buildFilmPills();
      applySearch();
    }

    function refresh(){ init(); }

    function applySearch(){
      const q = normalize(document.getElementById("q").value);

      if (currentTab === "films"){
        let list = films;

        // filter by category pill
        if (activeFilmCategory !== "Ø§Ù„ÙƒÙ„"){
          list = list.filter(x => (x.category || "Ø£ÙÙ„Ø§Ù…") === activeFilmCategory);
        }

        // search within filtered list
        if (q){
          list = list.filter(x => normalize(x.title).includes(q));
        }

        return renderFilms(list);
      }

      if (currentTab === "series"){
        let arr = Array.from(seriesMap.values());

        if (q){
          arr = arr.filter(s => normalize(s.title).includes(q) || normalize(s.genre).includes(q));
        }

        return renderSeriesCards(arr);
      }
    }

    function renderFilms(list){
      const el = document.getElementById("content");
      el.className = "grid";
      el.innerHTML = "";

      if (!list.length){
        el.innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙÙ„Ø§Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</div></div>`;
        return;
      }

      list.forEach(item => {
        const title = item.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const url = item.url || "";
        const image = item.image || PLACEHOLDER;
        const category = item.category || "Ø£ÙÙ„Ø§Ù…";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="poster"><img loading="lazy" src="${escapeHtml(image)}" alt="${escapeHtml(title)}"></div>
          <div class="meta">
            <h3>${escapeHtml(title)}</h3>
            <div class="badge">ğŸ¬ ${escapeHtml(category)}</div>
            <button class="btn primary" onclick="openFilm('${encodeURIComponent(title)}','${encodeURIComponent(url)}')">Ù…Ø´Ø§Ù‡Ø¯Ø©</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    function renderSeriesCards(list){
      const el = document.getElementById("content");
      el.className = "grid";
      el.innerHTML = "";

      if (!list.length){
        el.innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ù„Ø³Ù„Ø§Øª.</div></div>`;
        return;
      }

      list.forEach(series => {
        const title = series.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const image = series.image || PLACEHOLDER;
        const genre = series.genre || "";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="poster"><img loading="lazy" src="${escapeHtml(image)}" alt="${escapeHtml(title)}"></div>
          <div class="meta">
            <h3>${escapeHtml(title)}</h3>
            <div class="badge">ğŸ“º Ù…Ø³Ù„Ø³Ù„${genre ? " â€¢ " + escapeHtml(genre) : ""}</div>
            <div class="small">${series.episodes.length} Ø­Ù„Ù‚Ø©</div>
            <button class="btn primary" onclick="openSeries('${encodeURIComponent(title)}')">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</button>
          </div>
        `;
        el.appendChild(card);
      });
    }

    function openFilm(titleEnc, urlEnc){
      const title = decodeURIComponent(titleEnc);
      const url = decodeURIComponent(urlEnc);
      const params = new URLSearchParams();
      params.set("type", "film");
      params.set("title", title);
      params.set("src", url);
      window.location.href = "/watch.html?" + params.toString();
    }

    function openSeries(seriesTitleEnc){
      const title = decodeURIComponent(seriesTitleEnc);
      const series = seriesMap.get(title);
      if (!series) return;

      const el = document.getElementById("content");
      el.className = "";
      el.innerHTML = `
        <div class="panel" style="width:100%">
          <div class="panelHeader">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" onclick="applySearch()">â¬… Ø±Ø¬ÙˆØ¹</button>
              <h3>${escapeHtml(series.title)}</h3>
              ${series.genre ? `<span class="badge">${escapeHtml(series.genre)}</span>` : ""}
            </div>
            <div class="small">${series.episodes.length} Ø­Ù„Ù‚Ø©</div>
          </div>
          <div class="episodes" id="episodes"></div>
        </div>
      `;

      const eps = document.getElementById("episodes");
      series.episodes.forEach((ep, idx) => {
        const btn = document.createElement("button");
        btn.className = "epBtn";
        btn.innerHTML = `<span>${escapeHtml(ep.title || `Ø­Ù„Ù‚Ø© ${idx+1}`)}</span><span class="small">â–¶</span>`;
        btn.onclick = () => {
          const params = new URLSearchParams();
          params.set("type", "series-ep");
          params.set("series", series.title);
          params.set("ep", ep.title || `Ø­Ù„Ù‚Ø© ${idx+1}`);
          params.set("src", ep.url);
          window.location.href = "/watch.html?" + params.toString();
        };
        eps.appendChild(btn);
      });
    }

    async function init(){
      clearStatus();
      try{
        await loadCatalog();
        setActiveTab(currentTab);
        buildFilmPills();
        applySearch();
      }catch(e){
        showStatus(`<b style="color:#ef4444">âš  Ø®Ø·Ø£</b><div class="small">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ catalog: ${escapeHtml(e.message || String(e))}</div>`);
        document.getElementById("content").innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="small">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.</div></div>`;
      }
    }

    init();
  </script>
</body>
</html>
