<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…ÙƒØªØ¨Ø©</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#06070b; --bg1:#0b0e17; --stroke:#242a3f;
      --text:#e9ecf7; --muted:#aab2d3; --accent:#7c5cff; --accent2:#23d5ab;
      --shadow: 0 20px 60px rgba(0,0,0,.55); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Tajawal,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 75% 20%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 500px at 15% 80%, rgba(35,213,171,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding:22px 14px;
    }
    .wrap{max-width:1200px;margin:0 auto}
    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:26px}
    .sub{margin:6px 0 0;color:var(--muted);line-height:1.8}
    .search{
      min-width:260px; flex: 0 0 340px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:12px 12px; border-radius:14px; outline:none;
    }

    .tabs{display:flex;gap:10px; margin:10px 0 14px}
    .tab{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:800;
    }
    .tab.active{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.18);
    }

    #genreBar{display:none; gap:10px; flex-wrap:wrap; margin:0 0 14px}
    .genrePill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .genrePill.active{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.18);
    }

    .grid{display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));}

    .card{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(14,18,32,.65);
      box-shadow: var(--shadow);
      border-radius: 18px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border .15s ease, background .15s ease;
      position:relative;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(124,92,255,.45);
      background: rgba(14,18,32,.78);
    }

    .poster{width:100%; aspect-ratio:2/3; background:#000; position:relative; overflow:hidden;}
    .poster img{width:100%;height:100%;object-fit:cover;display:block;}
    .poster::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,transparent 55%, rgba(0,0,0,.70));pointer-events:none;}

    .meta{padding:10px 10px 12px;}
    .title{margin:0;font-weight:800;font-size:14px;line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    .hint{margin-top:6px;color:var(--muted);font-size:12px;}

    .badge{
      position:absolute; top:10px; left:10px;
      padding:6px 10px; border-radius:999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      font-size:12px; font-weight:900; color:#fff;
      display:flex; gap:6px; align-items:center;
      backdrop-filter: blur(8px);
    }

    .genreBadge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:900;
      font-size:12px;
      position:absolute;
      bottom:10px;
      right:10px;
      backdrop-filter: blur(8px);
    }

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .modal{
      width:min(620px, 100%);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,18,32,.92);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .modalTitle{margin:0;font-size:16px;font-weight:900}
    .closeBtn{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);color:var(--text);border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}
    .eps{max-height:60vh;overflow:auto;padding:12px 14px;display:grid;gap:10px}
    .epBtn{
      width:100%;
      text-align:right;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      font-weight:800;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .epBtn:hover{border-color: rgba(124,92,255,.45); background: rgba(255,255,255,.04);}

    .msg{color:var(--muted); margin-top:12px; min-height:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Ø§Ù„Ù…ÙƒØªØ¨Ø©</h1>
        <div class="sub">Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª â€” Ø§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯.</div>
      </div>
      <input id="q" class="search" placeholder="Ø§Ø¨Ø­Ø«..." />
    </div>

    <div class="tabs">
      <button id="tabMovies" class="tab active">Ø£ÙÙ„Ø§Ù…</button>
      <button id="tabSeries" class="tab">Ù…Ø³Ù„Ø³Ù„Ø§Øª</button>
    </div>

    <div id="genreBar"></div>

    <div id="grid" class="grid"></div>
    <div id="msg" class="msg"></div>
  </div>

  <div id="backdrop" class="backdrop">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle" class="modalTitle"></h3>
        <button id="closeBtn" class="closeBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="eps" class="eps"></div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const msg = document.getElementById("msg");
    const q = document.getElementById("q");
    const tabMovies = document.getElementById("tabMovies");
    const tabSeries = document.getElementById("tabSeries");
    const genreBar = document.getElementById("genreBar");

    const backdrop = document.getElementById("backdrop");
    const modalTitle = document.getElementById("modalTitle");
    const epsEl = document.getElementById("eps");
    const closeBtn = document.getElementById("closeBtn");

    let mode = "movies";
    let movies = [];
    let series = [];
    let seriesGenres = [];
    let selectedSeriesGenre = "ALL";

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function setMode(m){
      mode = m;
      tabMovies.classList.toggle("active", mode === "movies");
      tabSeries.classList.toggle("active", mode === "series");
      q.value = "";
      genreBar.style.display = (mode === "series") ? "flex" : "none";
      render();
    }

    function setActiveGenre(label){
      const pills = genreBar.querySelectorAll(".genrePill");
      pills.forEach(p => p.classList.remove("active"));
      for (const p of pills){
        if (p.textContent === label) p.classList.add("active");
      }
    }

    function buildGenreBar(){
      genreBar.innerHTML = "";
      const allBtn = document.createElement("button");
      allBtn.className = "genrePill active";
      allBtn.textContent = "Ø§Ù„ÙƒÙ„";
      allBtn.onclick = () => {
        selectedSeriesGenre = "ALL";
        setActiveGenre("Ø§Ù„ÙƒÙ„");
        render();
      };
      genreBar.appendChild(allBtn);

      for (const g of seriesGenres){
        const b = document.createElement("button");
        b.className = "genrePill";
        b.textContent = g;
        b.onclick = () => {
          selectedSeriesGenre = g;
          setActiveGenre(g);
          render();
        };
        genreBar.appendChild(b);
      }
    }

    function render(){
      const term = q.value.trim().toLowerCase();
      grid.innerHTML = "";

      if (mode === "movies") {
        const list = term ? movies.filter(x => (x.title||"").toLowerCase().includes(term)) : movies;

        for (const it of list){
          const el = document.createElement("div");
          el.className = "card";
          el.onclick = () => location.href = `/watch.html?id=${encodeURIComponent(it.id)}`;

          const img = it.image ? `<img loading="lazy" src="${escapeHtml(it.image)}" alt="${escapeHtml(it.title)}">` : "";

          el.innerHTML = `
            <div class="poster">
              ${img}
              <div class="badge">â–¶ Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
            </div>
            <div class="meta">
              <p class="title">${escapeHtml(it.title)}</p>
              <div class="hint">Ø§Ø¶ØºØ· Ù„Ù„ØªØ´ØºÙŠÙ„</div>
            </div>
          `;
          grid.appendChild(el);
        }

        msg.textContent = list.length ? `Ø§Ù„Ø£ÙÙ„Ø§Ù…: ${list.length}` : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.";
      } else {
        const list0 = term ? series.filter(x => (x.title||"").toLowerCase().includes(term)) : series;
        const list = (selectedSeriesGenre === "ALL")
          ? list0
          : list0.filter(x => (x.genre || "").trim() === selectedSeriesGenre);

        for (const s of list){
          const el = document.createElement("div");
          el.className = "card";
          el.onclick = () => openSeries(s);

          const img = s.image ? `<img loading="lazy" src="${escapeHtml(s.image)}" alt="${escapeHtml(s.title)}">` : "";

          el.innerHTML = `
            <div class="poster">
              ${img}
              <div class="badge">ğŸ“º Ø­Ù„Ù‚Ø§Øª</div>
              ${s.genre ? `<div class="genreBadge">${escapeHtml(s.genre)}</div>` : ""}
            </div>
            <div class="meta">
              <p class="title">${escapeHtml(s.title)}</p>
              <div class="hint">${s.count} Ø­Ù„Ù‚Ø© â€¢ Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</div>
            </div>
          `;
          grid.appendChild(el);
        }

        msg.textContent = list.length ? `Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª: ${list.length}` : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.";
      }
    }

    function openSeries(s){
      modalTitle.textContent = s.title;
      epsEl.innerHTML = "";

      for (const ep of (s.episodes || [])) {
        const b = document.createElement("button");
        b.className = "epBtn";
        b.innerHTML = `
          <span>${escapeHtml(ep.title)}</span>
          <span style="color:#aab2d3;font-weight:900;">â–¶</span>
        `;
        b.onclick = () => location.href = `/watch.html?id=${encodeURIComponent(ep.id)}`;
        epsEl.appendChild(b);
      }

      backdrop.style.display = "flex";
    }

    closeBtn.onclick = () => backdrop.style.display = "none";
    backdrop.onclick = (e) => { if (e.target === backdrop) backdrop.style.display = "none"; };

    tabMovies.onclick = () => setMode("movies");
    tabSeries.onclick = () => setMode("series");
    q.addEventListener("input", render);

    async function load(){
      const me = await fetch("/.netlify/functions/me").then(r=>r.json());
      if (!me.loggedIn) { location.href="/"; return; }

      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...";
      const res = await fetch("/.netlify/functions/catalog");
      const data = await res.json();

      if (!res.ok){
        msg.textContent = data.error || "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©";
        return;
      }

      movies = data.movies || [];
      series = data.series || [];
      seriesGenres = data.seriesGenres || [];
      buildGenreBar();

      setMode("movies");
      msg.textContent = "Ø¬Ø§Ù‡Ø².";
    }

    load();
  </script>
</body>
</html>
