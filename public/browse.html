<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SahraVTN | المكتبة</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f172a;
      --panel2:#0b1224;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:rgba(255,255,255,.08);
      --accent:#22c55e;
      --accent2:#38bdf8;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Arabic", "Noto Naskh Arabic", sans-serif;
      background:
        radial-gradient(900px 500px at 80% -10%, rgba(56,189,248,.14), transparent 60%),
        radial-gradient(900px 500px at 10% 10%, rgba(34,197,94,.14), transparent 55%),
        linear-gradient(180deg, #05070d, var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit; text-decoration:none}

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(11,15,23,.72);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1150px; margin:0 auto; padding:16px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:220px;
    }
    .logo{

      display:flex;align-items:center;justify-content:center;
    }
    .logo span{
      font-weight:800;
      font-size:14px;
      letter-spacing:.5px;
      color:#06110a;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      user-select:none;
    }

    /* Smart TV / old browser fallbacks */
    .poster{ aspect-ratio:auto; padding-top:150%; }
    .poster img{ position:absolute; top:0; left:0; right:0; bottom:0; }
    @supports (aspect-ratio: 2/3){
      .poster{ padding-top:0; aspect-ratio:2/3; }
      .poster img{ position:static; }
    }

    .logo{
      width:38px; height:38px;

      border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.9), rgba(56,189,248,.9));
      box-shadow: 0 10px 30px rgba(34,197,94,.12);
    }
    .brand h1{
      font-size:16px; margin:0; line-height:1.2;
    }
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .search{
      flex:1;
      min-width:240px;
      position:relative;
    }
    .search input{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      outline:none;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      transition: .15s;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }

    .section{
      padding:18px 0 36px;
    }
    .section-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin: 18px 0 12px;
    }
    .section-head h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .section-head .count{
      color:var(--muted);
      font-size:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (min-width:700px){ .grid{ grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (min-width:1020px){ .grid{ grid-template-columns: repeat(5, minmax(0, 1fr)); } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      transition: transform .12s ease, border-color .12s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(56,189,248,.22);
    }
    .poster{
      width:100%;
      aspect-ratio: 2/3;
      background: rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .poster img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05);
    }
    .badge{
      position:absolute;
      top:10px; right:10px;
      font-size:11px;
      padding:6px 8px;
      border-radius:12px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
    }
    .body{
      padding:10px 10px 12px;
    }
    .title{
      font-size:13px;
      margin:0 0 6px;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size:11px;
      color: var(--muted);
    }

    .notice{
      margin-top:14px;
      padding:12px 14px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:13px;
      line-height:1.6;
    }

    /* Pagination */
    .pager{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .pager .info{
      font-size:12px;
      color:var(--muted);
    }
    .pager .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pbtn{
      padding:9px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      transition:.12s;
    }
    .pbtn:hover{ border-color: rgba(56,189,248,.22); }
    .pbtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .pnum{
      padding:9px 10px;
      min-width:42px;
      text-align:center;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .pnum.active{
      color: var(--text);
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; z-index:100;
      background: rgba(0,0,0,.65);
      display:none;
      padding:16px;
      overflow:auto;
    }
    .modal-backdrop.show{ display:block; }
    .modal{
      max-width:860px;
      margin:0 auto;
      background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(11,18,36,.95));
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal-title{
      margin:0;
      font-size:15px;
      line-height:1.4;
    }
    .close-btn{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .modal-body{ padding:14px 16px 16px; }
    .modal-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width:700px){ .modal-grid{ grid-template-columns: repeat(2, 1fr); } }

    .ep{
      display:flex; gap:12px; align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.12s;
    }
    .ep:hover{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
    .ep .ep-title{ margin:0; font-size:13px; }
    .ep .ep-sub{ margin:0; font-size:12px; color: var(--muted); }
    .ep .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(56,189,248,.9);
      box-shadow: 0 0 0 4px rgba(56,189,248,.15);
      flex:0 0 auto;
      margin-top:2px;
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo" aria-label="SahraVTN" title="SahraVTN"><span>SV</span></div>
          <div>
            <h1>SahraVTN</h1>
            <p>المكتبة • أفلام + مسلسلات + أجنبي</p>
          </div>
        </div>

        <div class="search">
          <input id="q" type="search" placeholder="ابحث عن فيلم أو مسلسل..." autocomplete="off" />
        </div>

        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="films">الأفلام</div>
          <div class="tab" data-tab="tun-films">أفلام تونسية</div>
          <div class="tab" data-tab="series">المسلسلات</div>
          <div class="tab" data-tab="foreign">مسلسلات أجنبية</div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap section">
    <div id="content"></div>

    <div class="notice">
      إذا لم تعمل بعض الروابط فهذا غالباً بسبب قيود المصدر (CORS / صلاحيات السيرفر).
      بالنسبة للترجمة: يجب أن يكون رابط الـ VTT يسمح بالـ CORS.
    </div>
  </div>

  <!-- Episodes Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <h3 class="modal-title" id="modalTitle">الحلقات</h3>
        <button class="close-btn" id="closeModal">إغلاق</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid" id="modalEpisodes"></div>
      </div>
    </div>
  </div>

<script>
(function () {
  'use strict';

  // ---- helpers / polyfills (Smart TV friendly) ----
  function $(s) { return document.querySelector(s); }

  function safeText(v) { return (v == null ? '' : String(v)).replace(/^\s+|\s+$/g, ''); }

  function escapeHtml(str) {
    str = (str == null ? '' : String(str));
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function closest(el, sel) {
    // minimal closest polyfill
    while (el && el.nodeType === 1) {
      if (matches(el, sel)) return el;
      el = el.parentNode;
    }
    return null;
  }

  function matches(el, sel) {
    var p = Element.prototype;
    var f = p.matches || p.webkitMatchesSelector || p.msMatchesSelector || p.mozMatchesSelector;
    if (f) return f.call(el, sel);
    // very old fallback
    var nodes = (el.parentNode || document).querySelectorAll(sel);
    for (var i = 0; i < nodes.length; i++) if (nodes[i] === el) return true;
    return false;
  }

  function on(el, evt, fn) {
    if (!el) return;
    if (el.addEventListener) el.addEventListener(evt, fn, false);
    else if (el.attachEvent) el.attachEvent('on' + evt, fn);
  }

  function fetchJSON(url, cb) {
    // cb(err, data)
    if (window.fetch) {
      window.fetch(url, { cache: 'no-store' })
        .then(function (res) {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(function (data) { cb(null, data); })
        .catch(function (err) { cb(err); });
      return;
    }

    // XHR fallback for older browsers / TVs
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Cache-Control', 'no-cache');
    xhr.onreadystatechange = function () {
      if (xhr.readyState !== 4) return;
      if (xhr.status >= 200 && xhr.status < 300) {
        try { cb(null, JSON.parse(xhr.responseText)); }
        catch (e) { cb(e); }
      } else {
        cb(new Error('HTTP ' + xhr.status));
      }
    };
    xhr.send(null);
  }

  // ---- DOM refs ----
  var content = $('#content');
  var q = $('#q');
  var tabs = $('#tabs');
  var modalBackdrop = $('#modalBackdrop');
  var closeModal = $('#closeModal');
  var modalTitle = $('#modalTitle');
  var modalEpisodes = $('#modalEpisodes');

  var PAGE_SIZE = 10;

  var state = {
    tab: 'films',
    query: '',
    movies: [],
    series: [],
    foreign: [],
    pageByTab: {
      'films': 1,
      'tun-films': 1,
      'series': 1,
      'foreign': 1
    }
  };

  function setTab(tab) {
    state.tab = tab;
    var els = tabs ? tabs.querySelectorAll('.tab') : [];
    for (var i = 0; i < els.length; i++) {
      var el = els[i];
      if (el.classList) {
        if (el.getAttribute('data-tab') === tab) el.classList.add('active');
        else el.classList.remove('active');
      } else {
        // className fallback
        el.className = el.className.replace(/\bactive\b/g, '');
        if (el.getAttribute('data-tab') === tab) el.className += ' active';
      }
    }
    render();
  }

  function matchesQuery(text) {
    if (!state.query) return true;
    return safeText(text).toLowerCase().indexOf(state.query) !== -1;
  }

  function section(title, itemsCount) {
    var head = document.createElement('div');
    head.className = 'section-head';
    head.innerHTML =
      '<h2>' + escapeHtml(title) + '</h2>' +
      '<div class="count">' + itemsCount + ' عنصر</div>';
    return head;
  }

  function grid() {
    var el = document.createElement('div');
    el.className = 'grid';
    return el;
  }

  function card(opts) {
    var el = document.createElement('div');
    el.className = 'card';

    var image = safeText(opts.image);
    var badge = safeText(opts.badge);

    el.innerHTML =
      '<div class="poster">' +
        (image ? '<img src="' + escapeHtml(image) + '" alt="">' : '') +
        (badge ? '<div class="badge">' + escapeHtml(badge) + '</div>' : '') +
      '</div>' +
      '<div class="body">' +
        '<p class="title">' + escapeHtml(opts.title) + '</p>' +
        '<div class="meta">' +
          (opts.metaPills || []).map(function (p) {
            return '<span class="pill">' + escapeHtml(p) + '</span>';
          }).join('') +
        '</div>' +
      '</div>';

    on(el, 'click', opts.onClick);
    return el;
  }

  function paginate(items, tabKey) {
    var total = items.length;
    var totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    var page = state.pageByTab[tabKey] || 1;
    if (page > totalPages) page = totalPages;
    if (page < 1) page = 1;
    state.pageByTab[tabKey] = page;

    var start = (page - 1) * PAGE_SIZE;
    var end = start + PAGE_SIZE;
    var slice = items.slice(start, end);

    return { slice: slice, total: total, page: page, totalPages: totalPages, startIndex: start };
  }

  function renderPager(info) {
    var tabKey = info.tabKey, total = info.total, page = info.page, totalPages = info.totalPages, startIndex = info.startIndex;
    if (totalPages <= 1 && total <= PAGE_SIZE) return null;

    var pager = document.createElement('div');
    pager.className = 'pager';

    var from = total === 0 ? 0 : (startIndex + 1);
    var to = Math.min(startIndex + PAGE_SIZE, total);

    pager.innerHTML =
      '<div class="info">عرض ' + from + ' - ' + to + ' من ' + total + '</div>' +
      '<div class="controls"></div>';

    var controls = pager.querySelector('.controls');

    var prev = document.createElement('button');
    prev.className = 'pbtn';
    prev.appendChild(document.createTextNode('السابق'));
    prev.disabled = page <= 1;
    on(prev, 'click', function () {
      state.pageByTab[tabKey] = Math.max(1, page - 1);
      render();
      window.scrollTo(0, 0);
    });

    var next = document.createElement('button');
    next.className = 'pbtn';
    next.appendChild(document.createTextNode('التالي'));
    next.disabled = page >= totalPages;
    on(next, 'click', function () {
      state.pageByTab[tabKey] = Math.min(totalPages, page + 1);
      render();
      window.scrollTo(0, 0);
    });

    controls.appendChild(prev);

    var maxNums = 7;
    var startPage = Math.max(1, page - Math.floor(maxNums / 2));
    var endPage = Math.min(totalPages, startPage + maxNums - 1);
    startPage = Math.max(1, endPage - maxNums + 1);

    if (startPage > 1) {
      controls.appendChild(makePageNum(tabKey, 1, page));
      if (startPage > 2) controls.appendChild(makeDots());
    }

    for (var p = startPage; p <= endPage; p++) controls.appendChild(makePageNum(tabKey, p, page));

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) controls.appendChild(makeDots());
      controls.appendChild(makePageNum(tabKey, totalPages, page));
    }

    controls.appendChild(next);
    return pager;

    function makePageNum(tabKey2, p2, current) {
      var b = document.createElement('div');
      b.className = 'pnum' + (p2 === current ? ' active' : '');
      b.appendChild(document.createTextNode(String(p2)));
      on(b, 'click', function () {
        state.pageByTab[tabKey2] = p2;
        render();
        window.scrollTo(0, 0);
      });
      return b;
    }

    function makeDots() {
      var d = document.createElement('div');
      d.className = 'pnum';
      d.appendChild(document.createTextNode('…'));
      d.style.cursor = 'default';
      return d;
    }
  }

  function showModal(title, episodes) {
    modalTitle.textContent = title;
    modalEpisodes.innerHTML = '';

    for (var i = 0; i < episodes.length; i++) {
      (function (ep) {
        var epTitle = safeText(ep.title || ep.ep || 'حلقة');
        var episodeId = ep.id;
        var subs = Array.isArray(ep.subs) ? ep.subs : [];

        var el = document.createElement('div');
        el.className = 'ep';
        el.innerHTML =
          '<div class="dot"></div>' +
          '<div style="min-width:0">' +
            '<p class="ep-title">' + escapeHtml(epTitle) + '</p>' +
            '<p class="ep-sub">' + (subs.length ? ('ترجمة: ' + subs.length) : 'بدون ترجمة') + '</p>' +
          '</div>';

        on(el, 'click', function () {
          location.href = 'watch.html?id=' + encodeURIComponent(episodeId);
        });

        modalEpisodes.appendChild(el);
      })(episodes[i]);
    }

    if (modalBackdrop.classList) modalBackdrop.classList.add('show');
    else modalBackdrop.style.display = 'block';

    document.body.style.overflow = 'hidden';
  }

  function hideModal() {
    if (modalBackdrop.classList) modalBackdrop.classList.remove('show');
    else modalBackdrop.style.display = 'none';

    document.body.style.overflow = '';
  }

  function render() {
    content.innerHTML = '';

    if (state.tab === 'films') { renderFilms(false); return; }
    if (state.tab === 'tun-films') { renderFilms(true); return; }
    if (state.tab === 'series') { renderLocalSeries(); return; }
    if (state.tab === 'foreign') { renderForeignSeries(); return; }
  }

  function renderFilms(tunisianOnly) {
    var all = [];
    for (var i = 0; i < state.movies.length; i++) {
      var m = state.movies[i];
      if (!matchesQuery(m.title)) continue;
      var cat = safeText(m.category);
      if (tunisianOnly) {
        if (cat !== 'أفلام تونسية') continue;
      } else {
        if (cat !== 'أفلام') continue;
      }
      all.push(m);
    }

    var title = tunisianOnly ? 'أفلام تونسية' : 'الأفلام';
    content.appendChild(section(title, all.length));

    var tabKey = tunisianOnly ? 'tun-films' : 'films';
    var pg = paginate(all, tabKey);

    var g = grid();
    for (var j = 0; j < pg.slice.length; j++) {
      (function (m2) {
        var titleTxt = safeText(m2.title);
        var image = safeText(m2.image);
        var movieId = m2.id;

        g.appendChild(card({
          title: titleTxt,
          image: image,
          badge: tunisianOnly ? 'تونسية' : 'فيلم',
          metaPills: [ safeText(m2.category) || 'فيلم' ],
          onClick: function () { location.href = 'watch.html?id=' + encodeURIComponent(movieId); }
        }));
      })(pg.slice[j]);
    }

    content.appendChild(g);

    var pager = renderPager({ tabKey: tabKey, total: pg.total, page: pg.page, totalPages: pg.totalPages, startIndex: pg.startIndex });
    if (pager) content.appendChild(pager);
  }

  function renderLocalSeries() {
    var all = [];
    for (var i = 0; i < state.series.length; i++) {
      var s = state.series[i];
      if (matchesQuery(s.title)) all.push(s);
    }

    content.appendChild(section('المسلسلات', all.length));
    var pg = paginate(all, 'series');

    var g = grid();
    for (var j = 0; j < pg.slice.length; j++) {
      (function (s2) {
        var seriesName = safeText(s2.title);
        var image = safeText(s2.image);
        var episodes = Array.isArray(s2.episodes) ? s2.episodes : [];

        g.appendChild(card({
          title: seriesName,
          image: image,
          badge: 'مسلسل',
          metaPills: [ String(episodes.length) + ' حلقة' ],
          onClick: function () { showModal(seriesName, episodes); }
        }));
      })(pg.slice[j]);
    }

    content.appendChild(g);

    var pager = renderPager({ tabKey: 'series', total: pg.total, page: pg.page, totalPages: pg.totalPages, startIndex: pg.startIndex });
    if (pager) content.appendChild(pager);
  }

  function renderForeignSeries() {
    var all = [];
    for (var i = 0; i < state.foreign.length; i++) {
      var s = state.foreign[i];
      if (matchesQuery(s.title)) all.push(s);
    }

    content.appendChild(section('مسلسلات أجنبية', all.length));
    var pg = paginate(all, 'foreign');

    var g = grid();
    for (var j = 0; j < pg.slice.length; j++) {
      (function (s2) {
        var seriesName = safeText(s2.title);
        var image = safeText(s2.image);
        var episodes = Array.isArray(s2.episodes) ? s2.episodes : [];

        g.appendChild(card({
          title: seriesName,
          image: image,
          badge: 'أجنبي',
          metaPills: [ String(episodes.length) + ' حلقة' ],
          onClick: function () { showModal(seriesName, episodes); }
        }));
      })(pg.slice[j]);
    }

    content.appendChild(g);

    var pager = renderPager({ tabKey: 'foreign', total: pg.total, page: pg.page, totalPages: pg.totalPages, startIndex: pg.startIndex });
    if (pager) content.appendChild(pager);
  }

  // ---- events ----
  on(tabs, 'click', function (e) {
    e = e || window.event;
    var target = e.target || e.srcElement;
    var t = closest(target, '.tab');
    if (!t) return;
    setTab(t.getAttribute('data-tab'));
  });

  on(q, 'input', function () {
    state.query = safeText(q.value).toLowerCase();
    state.pageByTab[state.tab] = 1;
    render();
  });

  on(closeModal, 'click', hideModal);
  on(modalBackdrop, 'click', function (e) {
    e = e || window.event;
    var target = e.target || e.srcElement;
    if (target === modalBackdrop) hideModal();
  });

  on(document, 'keydown', function (e) {
    e = e || window.event;
    var key = e.key || e.keyCode;
    if (key === 'Escape' || key === 27) hideModal();
  });

  // ---- data loading ----
  function loadCatalog(done) {
    var url = '/.netlify/functions/catalog?t=' + (new Date().getTime());
    fetchJSON(url, function (err, data) {
      if (err) return done(err);

      if (data && typeof data === 'object' && !Array.isArray(data)) {
        state.movies = Array.isArray(data.movies) ? data.movies : [];
        state.series = Array.isArray(data.series) ? data.series : [];
        return done(null);
      }

      var arr = Array.isArray(data) ? data : [];
      var movies = [];
      var series = [];
      for (var i = 0; i < arr.length; i++) {
        var x = arr[i];
        if (x && x.title && x.url) movies.push(x);
        if (x && (x.seriesTitle || x.ep)) series.push(x);
      }
      state.movies = movies;
      state.series = series;
      done(null);
    });
  }

  function loadForeignSeries(done) {
    var url = '/.netlify/functions/foreignSeries?t=' + (new Date().getTime());
    fetchJSON(url, function (err, data) {
      if (err) return done(err);
      state.foreign = Array.isArray(data) ? data : [];
      done(null);
    });
  }

  function boot() {
    loadCatalog(function (err) {
      if (err) return showLoadError();
      loadForeignSeries(function (err2) {
        if (err2) return showLoadError();
        render();
      });
    });
  }

  function showLoadError() {
    content.innerHTML =
      '<div class="notice" style="border-color: rgba(239,68,68,.35); color:#fca5a5">' +
      'حصل خطأ أثناء تحميل المكتبة. تأكد أن Functions تعمل وأن الروابط:' +
      '<br>/.netlify/functions/catalog' +
      '<br>/.netlify/functions/foreignSeries' +
      '</div>';
  }

  boot();
})();
</script>


</body>
</html>
