<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</title>

  <!-- hls.js (only for .m3u8) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root{
      --bg:#070A12;
      --text:#EAF0FF;
      --muted:#A7B2D6;
      --line:rgba(255,255,255,.08);
      --accent:#7C5CFF;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 10% 0%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
      min-height:100vh;
    }
    header{
      max-width:1200px;
      margin: 18px auto 0;
      padding: 0 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; user-select:none; }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--accent), #4FD1C5);
      box-shadow: 0 0 0 6px rgba(124,92,255,.14);
    }
    .brand span{ font-weight:900; letter-spacing:.2px; }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition: .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(0px); }

    main{
      max-width:1200px;
      margin: 14px auto 28px;
      padding: 0 16px;
    }
    .shell{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .meta{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      border-bottom:1px solid var(--line);
      background: rgba(10,14,30,.55);
    }
    .meta .title{
      font-weight:950;
      font-size: 15px;
      line-height:1.25;
    }
    .meta .sub{
      color:var(--muted);
      font-size:12.5px;
      margin-top:4px;
    }

    .player-wrap{
      position:relative;
      background:#000;
    }

    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
      outline:none;
    }

    iframe{
      width:100%;
      aspect-ratio: 16 / 9;
      border:0;
      display:none;
      background:#000;
    }

    .float-controls{
      position:absolute;
      left:14px;
      bottom:14px;
      display:flex;
      gap:10px;
      z-index:4;
    }

    .chip{
      border:1px solid var(--line);
      background: rgba(10,14,30,.65);
      backdrop-filter: blur(10px);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:none;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      user-select:none;
    }
    .chip:hover{ background: rgba(10,14,30,.78); }

    .msg{
      padding: 14px 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      background: rgba(10,14,30,.35);
      border-top:1px solid var(--line);
    }
    .error{ color:#ffd0d0; }

    /* Smaller captions */
    video::cue{
      font-size: 14px;
      line-height: 1.35;
      background: rgba(0,0,0,.55);
    }
    @media (max-width:520px){
      .meta .title{ font-size: 14px; }
      video::cue{ font-size: 13px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="dot"></div>
      <span>Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
    </div>
    <button class="btn" id="backBtn">Ø±Ø¬ÙˆØ¹</button>
  </header>

  <main>
    <div class="shell">
      <div class="meta">
        <div>
          <div class="title" id="pageTitle">...</div>
          <div class="sub" id="pageSub">Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
        </div>
      </div>

      <div class="player-wrap">
        <!-- HLS / MP4 -->
        <video id="video" controls playsinline preload="metadata"></video>

        <!-- Bunny embed player -->
        <iframe id="bunnyFrame" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>

        <div class="float-controls">
          <div class="chip" id="unmuteBtn">ðŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</div>
          <div class="chip" id="subsBtn">ðŸ’¬ Ø§Ù„ØªØ±Ø¬Ù…Ø©</div>
        </div>
      </div>

      <div class="msg" id="statusText"></div>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);

    let type   = (qs.get("type") || "").toLowerCase(); // hls | mp4 | bunny (optional)
    const src  = qs.get("src") || "";
    const title  = qs.get("title") || "Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
    const poster = qs.get("poster") || "";

    // foreign series subtitles:
    const subkey = qs.get("subkey") || ""; // localStorage key that contains subs array
    const suburl = qs.get("sub") || "";    // direct vtt url

    const video = document.getElementById("video");
    const frame = document.getElementById("bunnyFrame");
    const pageTitle = document.getElementById("pageTitle");
    const statusText = document.getElementById("statusText");
    const backBtn = document.getElementById("backBtn");
    const unmuteBtn = document.getElementById("unmuteBtn");
    const subsBtn = document.getElementById("subsBtn");

    pageTitle.textContent = title;

    backBtn.addEventListener("click", () => {
      if (history.length > 1) history.back();
      else location.href = "browse.html";
    });

    function setStatus(text, isError=false){
      statusText.textContent = text || "";
      statusText.classList.toggle("error", !!isError);
    }

    // Detect Bunny embed URL even if "type" wasn't set
    function isBunnyEmbedUrl(u){
      if (!u) return false;
      try{
        const url = new URL(u);
        // Bunny embed player domain
        if (url.hostname.includes("player.mediadelivery.net")) return true;
      }catch(e){}
      // fallback string check
      return u.includes("player.mediadelivery.net/embed/");
    }

    async function tryAutoPlayVideo(){
      try { await video.play(); return true; } catch(e){ return false; }
    }

    function refreshUnmuteChip(){
      if (video.style.display !== "none" && video.muted) unmuteBtn.style.display = "inline-flex";
      else unmuteBtn.style.display = "none";
    }

    unmuteBtn.addEventListener("click", async () => {
      video.muted = false;
      refreshUnmuteChip();
      try { await video.play(); } catch(e){}
    });

    // ===== Subtitles =====
    function clearTracks(){
      Array.from(video.querySelectorAll("track")).forEach(t => t.remove());
    }

    function addTrack(vttUrl, lang="ar", label="Arabic", makeDefault=true){
      if (!vttUrl) return false;
      const track = document.createElement("track");
      track.kind = "subtitles";
      track.label = label;
      // IMPORTANT: use a valid-ish language code (NOT s1/s2)
      track.srclang = lang;
      track.src = vttUrl;
      if (makeDefault) track.default = true;

      video.appendChild(track);

      track.addEventListener("load", () => {
        try { track.track.mode = "showing"; } catch(e){}
      });

      return true;
    }

    function setupSubsToggle(){
      const tracks = video.textTracks;
      if (!tracks || !tracks.length) {
        subsBtn.style.display = "none";
        return;
      }
      subsBtn.style.display = "inline-flex";
      subsBtn.onclick = () => {
        const anyShowing = Array.from(tracks).some(t => t.mode === "showing");
        Array.from(tracks).forEach(t => t.mode = anyShowing ? "hidden" : "showing");
      };
    }

    function loadSubsFromLocalStorage(){
      if (!subkey) return false;
      try{
        const raw = localStorage.getItem(subkey);
        if (!raw) return false;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || !arr.length) return false;

        clearTracks();
        arr.forEach((s, idx) => {
          const url = s?.url || "";
          const label = s?.label || `SUB ${idx+1}`;
          const lang = idx === 0 ? "ar" : `ar-${idx+1}`;
          addTrack(url, lang, label, idx === 0);
        });

        setupSubsToggle();
        return true;
      }catch(e){
        return false;
      }
    }

    function loadSubsDirect(){
      if (!suburl) return false;
      clearTracks();
      addTrack(suburl, "ar", "Arabic", true);
      setupSubsToggle();
      return true;
    }

    // ===== Bunny embed (iframe) =====
    function initBunnyEmbed(){
      video.style.display = "none";
      frame.style.display = "block";
      unmuteBtn.style.display = "none";
      subsBtn.style.display = "none";

      if (!src) {
        setStatus("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", true);
        return;
      }

      // Add autoplay & muted for best chance to start.
      // (Bunny may still require user gesture depending on browser settings)
      let url = src;
      url += (url.includes("?") ? "&" : "?") + "autoplay=true&muted=true";

      frame.src = url;
      setStatus("");
    }

    // ===== HLS/MP4 (video) =====
    function initVideoPlayer(){
      video.style.display = "block";
      frame.style.display = "none";

      if (poster) video.poster = poster;

      // subtitles: foreign series (subkey) then direct sub=
      const subsLoaded = loadSubsFromLocalStorage() || loadSubsDirect();
      if (!subsLoaded) subsBtn.style.display = "none";

      if (!src) {
        setStatus("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", true);
        return;
      }

      // Try to autoplay. Browsers usually require MUTED for autoplay.
      video.muted = true;
      refreshUnmuteChip();

      const looksM3U8 = src.includes(".m3u8");

      if (type === "hls" || looksM3U8) {
        if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // Safari/iOS native
          video.src = src;
          video.addEventListener("loadedmetadata", async () => {
            await tryAutoPlayVideo();
            refreshUnmuteChip();
          }, { once:true });

        } else if (window.Hls && Hls.isSupported()) {
          const hls = new Hls({ lowLatencyMode:true, backBufferLength:90 });
          hls.loadSource(src);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, async () => {
            await tryAutoPlayVideo();
            refreshUnmuteChip();
          });

          hls.on(Hls.Events.ERROR, (evt, data) => {
            if (data?.fatal) {
              setStatus("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ Ø§Ù„Ù…ØµØ¯Ø±.", true);
              try { hls.destroy(); } catch(e){}
            }
          });

        } else {
          setStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·.", true);
        }

      } else {
        // MP4 direct
        video.src = src;
        video.addEventListener("loadedmetadata", async () => {
          await tryAutoPlayVideo();
          refreshUnmuteChip();
        }, { once:true });
      }

      setStatus("");
    }

    // ===== Boot =====
    (function(){
      setStatus("");

      // Auto-detect Bunny embed URLs (your films bunny player)
      const bunny = isBunnyEmbedUrl(src);

      // If it's Bunny embed, force bunny mode.
      if (bunny) type = "bunny";

      if (type === "bunny") initBunnyEmbed();
      else initVideoPlayer();
    })();
  </script>
</body>
</html>
