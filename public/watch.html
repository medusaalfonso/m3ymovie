<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشاهدة</title>

  <style>
    :root{
      --bg:#0b0f16; --txt:#e9eefb; --muted:#9fb0cc; --stroke:rgba(255,255,255,.08);
      --glow:rgba(96,165,250,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 85% 0%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(700px 450px at 10% 10%, rgba(167,139,250,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px 14px 34px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
    }
    .titleBox{display:flex;align-items:center;gap:12px;min-width:0}
    .poster{
      width:48px;height:48px;border-radius:12px;object-fit:cover;
      background:rgba(255,255,255,.06);border:1px solid var(--stroke);
      flex:0 0 auto;
    }
    h1{font-size:15px;margin:0;line-height:1.35;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
    .subline{margin:4px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s border-color, .15s box-shadow;
      display:inline-flex;align-items:center;gap:8px;text-decoration:none;user-select:none;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(96,165,250,.35);box-shadow:0 0 0 4px var(--glow)}
    .playerCard{
      margin-top:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 45px rgba(0,0,0,.35);
    }
    .playerInner{background:rgba(0,0,0,.35)}
    video{width:100%;height:auto;display:block;background:#000}
    .iframeWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000}
    .iframeWrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .meta{
      padding:14px 14px 16px;
      border-top:1px solid var(--stroke);
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg, rgba(15,22,35,.85), rgba(11,15,22,.85));
    }
    .pill{font-size:12px;color:var(--muted);padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.03)}
    .error{
      margin-top:14px;padding:12px 14px;border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.10);
      color:#ffd7d7;
      display:none;line-height:1.5;
      white-space:pre-wrap;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.18/dist/hls.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBox">
        <img id="posterImg" class="poster" alt="" />
        <div style="min-width:0">
          <h1 id="pageTitle">مشاهدة</h1>
          <div id="pageSub" class="subline"></div>
        </div>
      </div>
      <a class="btn" href="browse.html">⬅️ رجوع للمكتبة</a>
    </div>

    <div class="playerCard">
      <div class="playerInner" id="playerMount">
        <video id="video" controls playsinline crossorigin="anonymous" style="display:none;"></video>

        <div class="iframeWrap" id="iframeWrap" style="display:none;">
          <iframe id="bunnyFrame" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>

      <div class="meta">
        <div class="pill" id="typePill">—</div>
      </div>
    </div>

    <div id="errorBox" class="error"></div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);

  // type: "bunny" or "hls"
  const type   = (qs.get("type") || "").toLowerCase();
  const src    = qs.get("src") || "";
  const title  = qs.get("title") || "مشاهدة";
  const poster = qs.get("poster") || qs.get("img") || "";

  // subtitles can come as:
  // 1) subs= (JSON encoded array [{lang,label,url}, ...])
  // 2) sub=  (single vtt url)
  // 3) subkey= (if you use it to fetch episode object)
  const subsParam = qs.get("subs") || "";
  const subParam  = qs.get("sub")  || "";
  const subkey    = qs.get("subkey") || "";

  const video = document.getElementById("video");
  const iframeWrap = document.getElementById("iframeWrap");
  const bunnyFrame = document.getElementById("bunnyFrame");
  const pageTitle = document.getElementById("pageTitle");
  const pageSub = document.getElementById("pageSub");
  const posterImg = document.getElementById("posterImg");
  const typePill = document.getElementById("typePill");
  const errorBox = document.getElementById("errorBox");

  pageTitle.textContent = title;
  pageSub.textContent = src ? safeDecode(src).slice(0, 140) : "";
  if (poster) posterImg.src = poster; else posterImg.style.display = "none";

  typePill.textContent = (type === "bunny") ? "Bunny Player" : "HLS (m3u8)";

  function safeDecode(s){ try { return decodeURIComponent(s); } catch { return s; } }
  function showError(msg){ errorBox.style.display = "block"; errorBox.textContent = msg; }

  // ---------- SUBTITLES ----------
  function clearTracks(){
    video.querySelectorAll("track").forEach(t => t.remove());
  }

  // IMPORTANT:
  // srclang MUST be a real language code like "ar", not "s1"
  function normalizeLang(lang){
    const l = (lang || "").toLowerCase().trim();
    if (l === "ar" || l === "ara") return "ar";
    if (l === "en" || l === "eng") return "en";
    // your JSON uses s1/s2... -> treat as Arabic by default
    if (/^s\d+$/.test(l)) return "ar";
    return l || "ar";
  }

  function addTrack({url, label, lang, isDefault}){
    if (!url) return;
    const t = document.createElement("track");
    t.kind = "subtitles";
    t.label = label || "ترجمة";
    t.srclang = normalizeLang(lang);
    t.src = url;
    t.default = !!isDefault;
    video.appendChild(t);
  }

  function forceShowFirstTrack(){
    // after tracks are added, make sure browser enables them
    setTimeout(() => {
      try {
        if (video.textTracks && video.textTracks.length) {
          for (const tt of video.textTracks) tt.mode = "hidden";
          video.textTracks[0].mode = "showing";
        }
      } catch {}
    }, 250);
  }

  function parseSubsFromUrl(){
    // subs= JSON array in URL
    if (subsParam) {
      try {
        const decoded = safeDecode(subsParam);
        const arr = JSON.parse(decoded);
        if (Array.isArray(arr)) return arr;
      } catch {}
    }

    // sub= single VTT
    if (subParam) {
      const u = safeDecode(subParam).trim();
      if (u.startsWith("http")) return [{ lang: "ar", label: "العربية", url: u }];
    }

    return [];
  }

  async function loadSubsByKey(key){
    // If you still use subkey, this call must return either:
    // - { subs: [...] } OR
    // - just [...] directly
    const r = await fetch(`/.netlify/functions/foreignSeries?subkey=${encodeURIComponent(key)}`, { cache: "no-store" });
    if (!r.ok) throw new Error("subs fetch failed");
    return await r.json();
  }

  async function initSubs(){
    clearTracks();

    // 1) from URL (best, no extra request)
    let list = parseSubsFromUrl();

    // 2) from subkey (foreign series lookup)
    if ((!list || !list.length) && subkey) {
      try {
        const data = await loadSubsByKey(subkey);
        if (Array.isArray(data)) list = data;
        else if (data && Array.isArray(data.subs)) list = data.subs;
        else if (data && data.episode && Array.isArray(data.episode.subs)) list = data.episode.subs;
        else list = [];
      } catch {
        list = [];
      }
    }

    if (Array.isArray(list) && list.length) {
      list.forEach((s, i) => addTrack({
        url: s.url || s.src,
        label: s.label || (i === 0 ? "العربية" : `ترجمة ${i+1}`),
        lang: s.lang || "ar",
        isDefault: i === 0
      }));

      // THIS is what triggers the browser to re-evaluate tracks
      try { video.load(); } catch {}

      forceShowFirstTrack();
    }
  }

  // ---------- PLAYERS ----------
  function playHls(m3u8){
    if (!m3u8) { showError("رابط الفيديو غير موجود."); return; }

    video.style.display = "block";
    iframeWrap.style.display = "none";

    if (video.canPlayType("application/vnd.apple.mpegurl")) {
      video.src = m3u8;
      video.load();
      return;
    }

    if (window.Hls && window.Hls.isSupported()) {
      const hls = new Hls({ enableWorker: true });
      hls.attachMedia(video);
      hls.on(Hls.Events.MEDIA_ATTACHED, () => hls.loadSource(m3u8));
      hls.on(Hls.Events.ERROR, (ev, data) => {
        if (data && data.fatal) {
          showError("تعذر تشغيل الفيديو داخل المتصفح. غالباً المشكلة من CORS أو حماية السيرفر.");
          try { hls.destroy(); } catch {}
        }
      });
      return;
    }

    showError("متصفحك لا يدعم تشغيل m3u8 هنا.");
  }

  function playBunny(embedUrl){
    if (!embedUrl) { showError("رابط Bunny غير موجود."); return; }
    video.style.display = "none";
    iframeWrap.style.display = "block";
    bunnyFrame.src = embedUrl;
  }

  (async () => {
    // init subs first so tracks exist before play (better UX)
    await initSubs();

    if (type === "bunny") playBunny(src);
    else playHls(src);
  })();
})();
</script>
</body>
</html>
