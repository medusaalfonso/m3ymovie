<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --text:#e7edf6;
      --muted:#9bb0c7;
      --border:rgba(255,255,255,.08);
      --accent:#7c5cff;
      --shadow: 0 18px 60px rgba(0,0,0,.5);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 85% 10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 500px at 10% 10%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), #070a11 60%, #060810);
      color: var(--text);
      min-height:100vh;
    }

    .wrap{
      width:min(1100px, 92vw);
      margin:0 auto;
      padding: 18px 0 50px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:800;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(124,92,255,.35); }

    .titlebox{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding: 12px 14px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 12px;
    }
    .titlebox h1{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      line-height:1.35;
    }
    .titlebox .meta{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .pill.purple{ border-color: rgba(124,92,255,.4); color: rgba(214,206,255,.98); }

    .player-wrap{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .ratio{
      width:100%;
      aspect-ratio: 16/9;
      background: #000;
      position:relative;
    }

    video, iframe{
      width:100%;
      height:100%;
      display:block;
      background:#000;
    }

    .note{
      margin-top: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      box-shadow: var(--shadow);
    }
    .err{
      color: #fecaca;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/browse.html">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙƒØªØ¨Ø©</a>
      <button class="btn" id="copyLink">ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©</button>
    </div>

    <div class="titlebox">
      <div>
        <h1 id="t">â€”</h1>
        <div class="meta" id="m"></div>
      </div>
      <span class="pill purple" id="kind">â€”</span>
    </div>

    <div class="player-wrap">
      <div class="ratio" id="playerHost"></div>
    </div>

    <div class="note" id="note">
      Ø¥Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø§ ÙŠØ´ØªØºÙ„: Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ ØªØ£ÙƒØ¯ Ø£Ù† Ø±Ø§Ø¨Ø· m3u8 ØµØ­ÙŠØ­.
    </div>
  </div>

  <!-- Hls.js (for m3u8 on browsers that don't support native HLS like Chrome/Windows) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const params = new URLSearchParams(location.search);
    const type = (params.get("type") || "").toLowerCase();
    const src = params.get("src") || "";
    const title = params.get("title") || "Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
    const poster = params.get("poster") || "";

    // subtitles: allow repeated "sub" params:
    // sub = vttUrl|label|lang|default
    // example: sub=https://x/sub.vtt|Ø¹Ø±Ø¨ÙŠ|ar|1
    const subs = params.getAll("sub").map(s => {
      const parts = (s || "").split("|").map(x => x.trim());
      return {
        url: parts[0] || "",
        label: parts[1] || "Subtitles",
        lang: parts[2] || "en",
        isDefault: parts[3] === "1"
      };
    }).filter(x => x.url);

    $("t").textContent = title;
    $("kind").textContent =
      type === "bunny" ? "Bunny" :
      type === "dailymotion" ? "Dailymotion" :
      "HLS";

    // meta pills
    const meta = [];
    if (poster) meta.push(`<span class="pill">Poster âœ…</span>`);
    if (subs.length) meta.push(`<span class="pill">ØªØ±Ø¬Ù…Ø©: ${subs.length}</span>`);
    $("m").innerHTML = meta.join("");

    $("copyLink").onclick = async () => {
      try{
        await navigator.clipboard.writeText(location.href);
        $("note").textContent = "âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©.";
        setTimeout(() => $("note").textContent = "Ø¥Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø§ ÙŠØ´ØªØºÙ„: Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ ØªØ£ÙƒØ¯ Ø£Ù† Ø±Ø§Ø¨Ø· m3u8 ØµØ­ÙŠØ­.", 1200);
      }catch(e){
        $("note").innerHTML = `<span class="err">ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØµÙØ­.</span>`;
      }
    };

    function showError(msg){
      $("note").innerHTML = `<span class="err">${msg}</span>`;
    }

    function embedIframe(url){
      const host = $("playerHost");
      host.innerHTML = `
        <iframe
          src="${url}"
          frameborder="0"
          allow="autoplay; fullscreen"
          allowfullscreen
          referrerpolicy="no-referrer"
        ></iframe>
      `;
    }

    function playHls(url){
      const host = $("playerHost");
      host.innerHTML = `
        <video id="v" controls playsinline ${poster ? `poster="${poster}"` : ""}></video>
      `;

      const v = document.getElementById("v");

      // Attach subtitle tracks (VTT)
      // Note: Some browsers only show track menu when captions are valid + same-origin/CORS allows fetching.
      subs.forEach(s => {
        const tr = document.createElement("track");
        tr.kind = "subtitles";
        tr.label = s.label;
        tr.srclang = s.lang;
        tr.src = s.url;
        if (s.isDefault) tr.default = true;
        v.appendChild(tr);
      });

      // Native HLS (Safari) OR Hls.js (Chrome/Windows)
      if (v.canPlayType("application/vnd.apple.mpegurl")) {
        v.src = url;
        v.play().catch(()=>{});
        return;
      }

      if (window.Hls && window.Hls.isSupported()) {
        const hls = new Hls({
          maxBufferLength: 30,
          backBufferLength: 30,
        });
        hls.loadSource(url);
        hls.attachMedia(v);

        hls.on(Hls.Events.ERROR, function (event, data) {
          if (data && data.fatal) {
            showError("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ HLS: " + (data.details || "unknown"));
            try { hls.destroy(); } catch(e){}
          }
        });

        v.addEventListener("play", () => v.play().catch(()=>{}));
        return;
      }

      showError("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ m3u8. Ø¬Ø±Ù‘Ø¨ Chrome/Edge Ø­Ø¯ÙŠØ« Ø£Ùˆ Safari.");
    }

    // --- Main ---
    if (!src) {
      showError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ (src).");
    } else if (type === "bunny" || type === "dailymotion") {
      embedIframe(src);
    } else {
      // default HLS
      playHls(src);
    }
  </script>
</body>
</html>
