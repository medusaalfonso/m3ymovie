<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</title>

  <!-- hls.js (for .m3u8 on browsers without native HLS) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root{
      --bg:#070A12;
      --card:#0D1325;
      --card2:#0B1020;
      --text:#EAF0FF;
      --muted:#A7B2D6;
      --line:rgba(255,255,255,.08);
      --accent:#7C5CFF;
      --accent2:#22C55E;
      --danger:#EF4444;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 10% 0%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
      min-height:100vh;
    }

    header{
      max-width:1200px;
      margin: 18px auto 0;
      padding: 0 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--accent), #4FD1C5);
      box-shadow: 0 0 0 6px rgba(124,92,255,.14);
    }
    .brand span{
      font-weight:800;
      letter-spacing:.2px;
    }

    .top-actions{
      display:flex; gap:10px; align-items:center;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition: .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(0px); }

    .btn-accent{
      border-color: rgba(124,92,255,.35);
      background: rgba(124,92,255,.18);
    }

    main{
      max-width:1200px;
      margin: 14px auto 28px;
      padding: 0 16px;
    }

    .shell{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .meta{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      border-bottom:1px solid var(--line);
      background: rgba(10,14,30,.55);
    }
    .meta .title{
      font-weight:900;
      font-size: 15px;
      line-height:1.2;
    }
    .meta .sub{
      color:var(--muted);
      font-size:12.5px;
      margin-top:4px;
    }

    .player-wrap{
      position:relative;
      background: #000;
    }

    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
      outline:none;
    }

    iframe{
      width:100%;
      aspect-ratio: 16 / 9;
      border:0;
      display:none;
      background:#000;
    }

    /* Small floating controls (no big overlay) */
    .float-controls{
      position:absolute;
      left:14px;
      bottom:14px;
      display:flex;
      gap:10px;
      z-index:4;
    }

    .chip{
      border:1px solid var(--line);
      background: rgba(10,14,30,.65);
      backdrop-filter: blur(10px);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      display:none; /* shown only when needed */
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      user-select:none;
    }
    .chip:hover{ background: rgba(10,14,30,.78); }

    .chip-green{ border-color: rgba(34,197,94,.35); }
    .chip-purple{ border-color: rgba(124,92,255,.4); }

    .msg{
      padding: 14px 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      background: rgba(10,14,30,.35);
      border-top:1px solid var(--line);
    }

    .error{
      color: #ffd0d0;
    }

    /* Smaller captions */
    video::cue{
      font-size: 14px;
      line-height: 1.35;
      background: rgba(0,0,0,.55);
    }

    @media (max-width:520px){
      .meta .title{ font-size: 14px; }
      video::cue{ font-size: 13px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="dot"></div>
      <span>Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
    </div>

    <div class="top-actions">
      <button class="btn" id="backBtn">Ø±Ø¬ÙˆØ¹</button>
    </div>
  </header>

  <main>
    <div class="shell">
      <div class="meta">
        <div>
          <div class="title" id="pageTitle">...</div>
          <div class="sub" id="pageSub">Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
        </div>
      </div>

      <div class="player-wrap">
        <!-- HLS / MP4 -->
        <video id="video" controls playsinline preload="metadata"></video>

        <!-- Bunny embed -->
        <iframe id="bunnyFrame" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>

        <div class="float-controls">
          <div class="chip chip-green" id="unmuteBtn">ðŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</div>
          <div class="chip chip-purple" id="subsBtn">ðŸ’¬ Ø§Ù„ØªØ±Ø¬Ù…Ø©</div>
        </div>
      </div>

      <div class="msg" id="statusText"></div>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);

    const type   = (qs.get("type") || "").toLowerCase(); // hls | mp4 | bunny
    const src    = qs.get("src") || "";
    const title  = qs.get("title") || "Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
    const poster = qs.get("poster") || "";
    const subkey = qs.get("subkey") || ""; // key in localStorage (for foreign series)
    const suburl = qs.get("sub") || "";    // direct vtt url (optional)

    const video = document.getElementById("video");
    const frame = document.getElementById("bunnyFrame");
    const pageTitle = document.getElementById("pageTitle");
    const statusText = document.getElementById("statusText");
    const backBtn = document.getElementById("backBtn");
    const unmuteBtn = document.getElementById("unmuteBtn");
    const subsBtn = document.getElementById("subsBtn");

    pageTitle.textContent = title;

    backBtn.addEventListener("click", () => {
      // go back safely
      if (history.length > 1) history.back();
      else location.href = "browse.html";
    });

    // Helper: show short status
    function setStatus(text, isError=false){
      statusText.textContent = text;
      statusText.classList.toggle("error", !!isError);
    }

    // Helper: attempt autoplay (will likely require muted)
    async function tryAutoPlay(){
      try {
        await video.play();
        return true;
      } catch(e){
        return false;
      }
    }

    // Show a small "unmute" chip only if video is muted
    function refreshUnmuteChip(){
      if (video.style.display !== "none" && video.muted) {
        unmuteBtn.style.display = "inline-flex";
      } else {
        unmuteBtn.style.display = "none";
      }
    }

    unmuteBtn.addEventListener("click", async () => {
      video.muted = false;
      refreshUnmuteChip();
      try { await video.play(); } catch(e){}
    });

    // ===== Subtitles loading =====
    function clearTracks(){
      const tracks = Array.from(video.querySelectorAll("track"));
      tracks.forEach(t => t.remove());
    }

    function addTrack(vttUrl, lang="ar", label="Arabic", makeDefault=true){
      if (!vttUrl) return false;

      const track = document.createElement("track");
      track.kind = "subtitles";
      track.label = label;
      track.srclang = lang;         // IMPORTANT: must be a valid-ish language code, not "s1"
      track.src = vttUrl;
      if (makeDefault) track.default = true;

      video.appendChild(track);

      // ensure browser actually shows it
      // after it loads, we set mode to showing
      track.addEventListener("load", () => {
        try { track.track.mode = "showing"; } catch(e){}
      });

      return true;
    }

    function loadSubsFromLocalStorage(){
      if (!subkey) return false;
      try{
        const raw = localStorage.getItem(subkey);
        if (!raw) return false;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || !arr.length) return false;

        clearTracks();

        // Your JSON has subs like [{lang:"s1",label:"SUB 1",url:"..."}]
        // We'll map them to valid srclang codes: ar, ar-1, ar-2...
        arr.forEach((s, idx) => {
          const url = s?.url || "";
          const label = s?.label || `SUB ${idx+1}`;
          const lang = idx === 0 ? "ar" : `ar-${idx+1}`;
          addTrack(url, lang, label, idx === 0);
        });

        subsBtn.style.display = "inline-flex";
        subsBtn.onclick = () => {
          // toggle subtitles show/hide
          const textTracks = video.textTracks;
          if (!textTracks || !textTracks.length) return;

          const anyShowing = Array.from(textTracks).some(t => t.mode === "showing");
          Array.from(textTracks).forEach(t => t.mode = anyShowing ? "hidden" : "showing");
        };

        return true;
      }catch(e){
        return false;
      }
    }

    function loadSubsDirect(){
      if (!suburl) return false;
      clearTracks();
      addTrack(suburl, "ar", "Arabic", true);

      subsBtn.style.display = "inline-flex";
      subsBtn.onclick = () => {
        const textTracks = video.textTracks;
        if (!textTracks || !textTracks.length) return;

        const anyShowing = Array.from(textTracks).some(t => t.mode === "showing");
        Array.from(textTracks).forEach(t => t.mode = anyShowing ? "hidden" : "showing");
      };

      return true;
    }

    // ===== Player init =====
    async function initBunny(){
      // Hide video, show iframe
      video.style.display = "none";
      frame.style.display = "block";
      unmuteBtn.style.display = "none";
      subsBtn.style.display = "none";

      // Add autoplay params (Bunny may still require muted)
      let bunnyUrl = src;
      if (!bunnyUrl) {
        setStatus("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", true);
        return;
      }
      bunnyUrl += (bunnyUrl.includes("?") ? "&" : "?") + "autoplay=true&muted=true";
      frame.src = bunnyUrl;

      setStatus("");
    }

    async function initHlsOrMp4(){
      // Show video, hide iframe
      video.style.display = "block";
      frame.style.display = "none";

      if (poster) video.poster = poster;

      // Load subtitles first (so they appear when video starts)
      // Priority: localStorage subs (foreign series) then direct sub url
      const loadedSubs = loadSubsFromLocalStorage() || loadSubsDirect();
      if (!loadedSubs) {
        subsBtn.style.display = "none";
      }

      // Set source
      if (!src) {
        setStatus("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", true);
        return;
      }

      // Try autoplay (will succeed only if muted on most browsers)
      // We start muted to ensure it actually autoplays.
      video.muted = true;
      refreshUnmuteChip();

      // HLS
      if (type === "hls" || src.includes(".m3u8")) {
        if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = src;

          // iOS Safari: autoplay attempt after metadata
          video.addEventListener("loadedmetadata", async () => {
            const ok = await tryAutoPlay();
            refreshUnmuteChip();
            if (!ok) setStatus("");
          }, { once:true });

        } else if (window.Hls && Hls.isSupported()) {
          const hls = new Hls({
            lowLatencyMode: true,
            backBufferLength: 90
          });

          hls.loadSource(src);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, async () => {
            const ok = await tryAutoPlay();
            refreshUnmuteChip();
            if (!ok) setStatus("");
          });

          hls.on(Hls.Events.ERROR, (evt, data) => {
            // No debug spam; show simple message
            if (data?.fatal) {
              setStatus("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ Ø§Ù„Ù…ØµØ¯Ø±.", true);
              try { hls.destroy(); } catch(e){}
            }
          });

        } else {
          setStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·.", true);
        }

      } else {
        // MP4 / direct
        video.src = src;
        video.addEventListener("loadedmetadata", async () => {
          const ok = await tryAutoPlay();
          refreshUnmuteChip();
          if (!ok) setStatus("");
        }, { once:true });
      }

      // If user interacts anywhere, we can unmute if they want
      // (we don't auto-unmute; that would fail)
      document.addEventListener("click", () => {
        refreshUnmuteChip();
      }, { once:true });

      setStatus("");
    }

    (async function(){
      setStatus("");

      if (type === "bunny") {
        await initBunny();
      } else {
        await initHlsOrMp4();
      }
    })();
  </script>
</body>
</html>
