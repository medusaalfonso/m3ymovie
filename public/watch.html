<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>المشاهدة</title>

  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.7);
      --accent:#7c5cff;
      --border:rgba(255,255,255,.12);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 70% 10%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(700px 450px at 10% 30%, rgba(72,200,255,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px 14px 40px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1.2;
      color:var(--text);
      opacity:.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 72vw;
    }
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 8px 22px rgba(0,0,0,.18);
      transition: transform .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.2)}

    .playerCard{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* Video/iframe area */
    .stage{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      background:#000;
    }
    video, iframe{
      width:100%;
      height:100%;
      display:block;
      background:#000;
    }
    iframe{border:0}

    /* Clean overlay play button (only when autoplay is blocked) */
    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(2px);
      background: radial-gradient(600px 350px at 50% 40%, rgba(0,0,0,.35), rgba(0,0,0,.65));
    }
    .overlay.show{display:flex}
    .overlayBtn{
      border:1px solid rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(124,92,255,.35), rgba(124,92,255,.18));
      color:var(--text);
      padding:14px 18px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
    }
    .overlayBtn span{
      display:inline-block;
      width:0;height:0;
      border-top:8px solid transparent;
      border-bottom:8px solid transparent;
      border-left:12px solid var(--text);
      opacity:.95;
    }

    /* Captions: make them smaller + clean */
    video::cue{
      font-size: 14px;
      line-height: 1.35;
      color: #fff;
      background: rgba(0,0,0,.55);
      padding: .10em .35em;
      border-radius: .35em;
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
    }
    /* optional: slightly bigger on big screens */
    @media (min-width: 900px){
      video::cue{ font-size: 15px; }
    }

    .meta{
      padding:14px 14px 16px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .meta .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .meta .hint{
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 85vw;
    }

    .subsRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
    }
  </style>

  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title" id="pageTitle">المشاهدة</div>
      <a class="btn" href="browse.html">رجوع للمكتبة</a>
    </div>

    <div class="playerCard">
      <div class="stage" id="stage">
        <video id="video" controls playsinline preload="metadata" style="display:none"></video>
        <iframe id="bunnyFrame" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="display:none"></iframe>

        <div class="overlay" id="overlay">
          <button class="overlayBtn" id="overlayPlay">
            <span></span>
            تشغيل
          </button>
        </div>
      </div>

      <div class="meta">
        <div class="left">
          <div class="hint" id="hint"> </div>
          <div class="subsRow" id="subsRow" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);

  const type   = (qs.get("type") || "").toLowerCase();  // hls | bunny | ...
  const src    = qs.get("src") || "";
  const title  = qs.get("title") || "المشاهدة";
  const poster = qs.get("poster") || "";
  const subkey = qs.get("subkey") || ""; // (optional) if you store subs in localStorage

  const elTitle = document.getElementById("pageTitle");
  const elHint  = document.getElementById("hint");
  const video   = document.getElementById("video");
  const frame   = document.getElementById("bunnyFrame");
  const overlay = document.getElementById("overlay");
  const overlayPlay = document.getElementById("overlayPlay");
  const subsRow = document.getElementById("subsRow");

  elTitle.textContent = title;

  // Helper: safe decode for JSON passed in URL (if you ever use it)
  function safeJsonParse(str){
    try { return JSON.parse(str); } catch(e){ return null; }
  }

  // Subtitles come from 2 possible places:
  // 1) URL param "subs" as JSON (optional)
  // 2) localStorage by subkey (what your URL currently uses)
  let subs = [];
  const subsParam = qs.get("subs");
  if (subsParam){
    const parsed = safeJsonParse(decodeURIComponent(subsParam));
    if (Array.isArray(parsed)) subs = parsed;
  } else if (subkey){
    try{
      const stored = localStorage.getItem(subkey);
      const parsed = stored ? JSON.parse(stored) : null;
      if (Array.isArray(parsed)) subs = parsed;
    } catch(e){}
  }

  // Decide if Bunny embed
  const isBunnyEmbed = type === "bunny" || src.includes("player.mediadelivery.net/embed/");

  // =========================
  // Bunny Player (iframe)
  // =========================
  if (isBunnyEmbed){
    frame.style.display = "block";
    video.style.display = "none";
    overlay.classList.remove("show");

    // Use the src directly (your catalog should already provide the embed url)
    frame.src = src;

    // No “click to play” overlay here; Bunny controls its own playback rules.
    elHint.textContent = "";
    subsRow.style.display = "none";
    return;
  }

  // =========================
  // HLS / MP4 video (video tag)
  // =========================
  video.style.display = "block";
  frame.style.display = "none";

  if (poster) video.poster = poster;

  // Remove any old tracks (important when navigating between episodes)
  function clearTracks(){
    const tracks = video.querySelectorAll("track");
    tracks.forEach(t => t.remove());
  }

  // Add VTT tracks (this makes the browser request the VTT)
  function addTracks(subs){
    clearTracks();
    if (!Array.isArray(subs) || subs.length === 0){
      subsRow.style.display = "none";
      return;
    }

    subsRow.style.display = "flex";
    subsRow.innerHTML = "";

    // Show a small hint pill list (not a debug URL)
    subs.forEach((s, idx) => {
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = s.label || ("SUB " + (idx + 1));
      subsRow.appendChild(pill);
    });

    // Create actual <track> elements
    subs.forEach((s, idx) => {
      if (!s || !s.url) return;

      const track = document.createElement("track");
      track.kind = "subtitles";
      track.label = s.label || ("SUB " + (idx + 1));
      // Use lang from json: "s1", "s2" ... (valid enough)
      track.srclang = (s.lang || ("s" + (idx + 1))).toString().toLowerCase();
      track.src = "/.netlify/functions/subtitleProxy?url=" + encodeURIComponent(s.url);

      // Only first one default (so user sees it in CC menu)
      if (idx === 0) track.default = true;

      video.appendChild(track);
    });
  }

  addTracks(subs);

  // Load source with HLS.js if needed
  let hls = null;
  function loadVideoSource(url){
    // if .m3u8 -> HLS.js or native (Safari)
    const isM3U8 = url.includes(".m3u8") || type === "hls";

    if (hls){
      try{ hls.destroy(); }catch(e){}
      hls = null;
    }

    if (isM3U8){
      if (video.canPlayType("application/vnd.apple.mpegurl")){
        // Safari / iOS native
        video.src = url;
      } else if (window.Hls && Hls.isSupported()){
        hls = new Hls({
          // keep default; you can tune later if you want
          enableWorker: true
        });
        hls.loadSource(url);
        hls.attachMedia(video);
      } else {
        // fallback: set src (may not work in many browsers)
        video.src = url;
      }
    } else {
      // mp4 direct
      video.src = url;
    }
  }

  loadVideoSource(src);

  // Clean hint line (NO raw URL)
  elHint.textContent = "";

  // =========================
  // Autoplay (no forced mute)
  // =========================
  async function tryAutoplay(){
    // Some browsers block autoplay with sound.
    // We try with sound. If it fails, show our overlay button.
    try{
      await video.play();
      overlay.classList.remove("show");
    }catch(err){
      overlay.classList.add("show");
    }
  }

  // Try after metadata/manifest is ready
  video.addEventListener("loadedmetadata", tryAutoplay, { once:true });

  // If using HLS.js, also try after manifest parsed
  if (window.Hls && Hls.isSupported()){
    // we might not have hls immediately, so poll briefly
    const t0 = Date.now();
    const timer = setInterval(() => {
      if (hls){
        clearInterval(timer);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          tryAutoplay();
        });
      } else if (Date.now() - t0 > 2000){
        clearInterval(timer);
      }
    }, 50);
  }

  overlayPlay.addEventListener("click", async () => {
    try{
      // user gesture => should allow play with sound
      await video.play();
      overlay.classList.remove("show");
    }catch(e){}
  });

})();
</script>
</body>
</html>
