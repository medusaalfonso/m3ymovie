<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>المشاهدة</title>

  <style>
    :root{
      --bg:#0b0f18;
      --panel:#11182a;
      --txt:#e9eefc;
      --muted:#a6b2d6;
      --stroke:rgba(255,255,255,.10);
      --r:18px;
      --shadow:0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(900px 420px at 80% -10%, rgba(124,92,255,.35), transparent 55%),
                 radial-gradient(800px 380px at 20% 0%, rgba(110,168,255,.28), transparent 55%),
                 var(--bg);
      color:var(--txt);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:14px 14px;border:1px solid var(--stroke);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .title{font-weight:900}
    .muted{color:var(--muted);font-size:12px;font-weight:700}
    .btn{
      cursor:pointer;border:1px solid var(--stroke);border-radius:14px;
      padding:10px 12px;background:rgba(255,255,255,.06);color:var(--txt);
      font-weight:800;
    }
    .playerBox{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius:22px;
      overflow:hidden;
      background:rgba(0,0,0,.25);
      box-shadow:var(--shadow);
    }
    video{
      width:100%;
      height:auto;
      background:#000;
      display:block;
    }
    .iframeWrap{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
    }
    .iframeWrap iframe{
      position:absolute;inset:0;width:100%;height:100%;
      border:0;
    }
    .bar{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:12px 14px;border-top:1px solid var(--stroke);
      background:rgba(17,24,42,.75);
    }
    .pill{
      border:1px solid var(--stroke);border-radius:999px;
      padding:6px 10px;background:rgba(255,255,255,.04);
      color:var(--muted);font-size:12px;font-weight:800;
    }
  </style>

  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div id="t" class="title">...</div>
        <div id="s" class="muted"></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <a class="btn" href="/browse.html">رجوع للمكتبة</a>
      </div>
    </div>

    <div class="playerBox" id="box">
      <!-- will be filled -->
    </div>

    <div class="bar">
      <span id="mode" class="pill">...</span>
      <span id="subsInfo" class="pill">ترجمة: ...</span>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const type = params.get("type") || "";
  const src  = params.get("src")  || "";
  const title = params.get("title") || "مشاهدة";
  const poster = params.get("poster") || "";

  const elT = document.getElementById("t");
  const elS = document.getElementById("s");
  const elBox = document.getElementById("box");
  const elMode = document.getElementById("mode");
  const elSubsInfo = document.getElementById("subsInfo");

  elT.textContent = title;
  elS.textContent = src ? decodeURIComponent(src) : "";

  function b64UrlDecodeToText(b64url){
    const b64 = (b64url || "").replace(/-/g,'+').replace(/_/g,'/');
    const pad = b64.length % 4 ? "=".repeat(4 - (b64.length % 4)) : "";
    const bin = atob(b64 + pad);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }

  function parseSubs(){
    // subs can be passed as base64url(JSON array)
    const subsB64 = params.get("subs");
    if(subsB64){
      try{
        const txt = b64UrlDecodeToText(subsB64);
        const arr = JSON.parse(txt);
        if(Array.isArray(arr)) return arr;
      }catch(_){}
    }

    // or single sub url
    const sub = params.get("sub");
    if(sub) return [{lang:"ar", label:"Arabic", url: sub}];

    return [];
  }

  function clearTracks(video){
    // remove existing <track>
    const tracks = Array.from(video.querySelectorAll("track"));
    tracks.forEach(t => t.remove());

    // also disable any text tracks already loaded
    const tts = video.textTracks;
    for(let i=0;i<tts.length;i++){
      try{ tts[i].mode = "disabled"; }catch(_){}
    }
  }

  function addTracks(video, subs){
    clearTracks(video);

    if(!subs || !subs.length){
      elSubsInfo.textContent = "ترجمة: لا توجد";
      return;
    }

    subs.forEach((s, idx) => {
      if(!s || !s.url) return;

      const tr = document.createElement("track");
      tr.kind = "subtitles";
      tr.src = s.url;
      tr.srclang = s.lang || ("s" + (idx+1));   // your json uses s1/s2...
      tr.label = s.label || ("SUB " + (idx+1));
      tr.default = (idx === 0);
      video.appendChild(tr);
    });

    // IMPORTANT: force reload so the browser requests VTT
    video.load();

    elSubsInfo.textContent = "ترجمة: متاحة";
  }

  async function resolveRedirect(url){
    // for shofha links that redirect to final playable URL
    const r = await fetch("/.netlify/functions/resolve?u=" + encodeURIComponent(url) + "&t=" + Date.now(), {cache:"no-store"});
    if(!r.ok) throw new Error("resolve failed");
    const j = await r.json();
    // expected: { url: "final.m3u8" } or { url: "final.mp4" }
    return j.url || j.finalUrl || j.location || "";
  }

  function mountHlsPlayer(hlsUrl, subs){
    elMode.textContent = "مشغل: HLS";

    const v = document.createElement("video");
    v.controls = true;
    v.playsInline = true;

    // allow external subtitle fetching
    v.crossOrigin = "anonymous";

    if(poster) v.poster = poster;

    elBox.innerHTML = "";
    elBox.appendChild(v);

    // tracks
    addTracks(v, subs);

    // hls
    if(window.Hls && Hls.isSupported()){
      const hls = new Hls({
        enableWorker: true,
        lowLatencyMode: false
      });
      hls.loadSource(hlsUrl);
      hls.attachMedia(v);
    }else{
      // Safari (native HLS)
      v.src = hlsUrl;
    }
  }

  function mountMp4Player(mp4Url, subs){
    elMode.textContent = "مشغل: MP4";

    const v = document.createElement("video");
    v.controls = true;
    v.playsInline = true;
    v.crossOrigin = "anonymous";
    if(poster) v.poster = poster;

    elBox.innerHTML = "";
    elBox.appendChild(v);

    addTracks(v, subs);

    v.src = mp4Url;
  }

  function mountBunny(embedUrl){
    elMode.textContent = "مشغل: Bunny (iframe)";
    elSubsInfo.textContent = "ترجمة: عبر المشغل";

    elBox.innerHTML = `
      <div class="iframeWrap">
        <iframe
          src="${embedUrl}"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      </div>
    `;
  }

  (async function init(){
    if(!src){
      elBox.innerHTML = "<div style='padding:16px;color:#a6b2d6'>لا يوجد رابط تشغيل.</div>";
      elMode.textContent = "مشغل: -";
      elSubsInfo.textContent = "ترجمة: -";
      return;
    }

    const subs = parseSubs();

    if(type === "bunny"){
      mountBunny(src);
      return;
    }

    if(type === "hls"){
      mountHlsPlayer(src, subs);
      return;
    }

    if(type === "mp4"){
      mountMp4Player(src, subs);
      return;
    }

    if(type === "redirect"){
      // best effort: resolve to final url (m3u8/mp4) using your function
      try{
        const finalUrl = await resolveRedirect(src);
        if(finalUrl.endsWith(".m3u8")) return mountHlsPlayer(finalUrl, subs);
        return mountMp4Player(finalUrl, subs);
      }catch(_){
        // fallback: try as-is
        if(src.endsWith(".m3u8")) return mountHlsPlayer(src, subs);
        return mountMp4Player(src, subs);
      }
    }

    // fallback
    if(src.includes("player.mediadelivery.net/embed/")){
      mountBunny(src);
      return;
    }
    if(src.endsWith(".m3u8")){
      mountHlsPlayer(src, subs);
      return;
    }
    mountMp4Player(src, subs);
  })();
</script>
</body>
</html>
