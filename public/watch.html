<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</title>

  <!-- HLS.js for m3u8 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1626;
      --card2:#121c30;
      --text:#e7ecff;
      --muted:#a8b2d1;
      --border:rgba(255,255,255,.08);
      --accent:#7c5cff;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% 10%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      direction: rtl;
    }
    .container{max-width:1100px;margin:0 auto;padding:22px}
    .nav{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 18px;border:1px solid var(--border);
      background:rgba(15,22,38,.7);backdrop-filter: blur(10px);
      border-radius:16px;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.7);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color: rgba(124,92,255,.45)}
    .btn.primary{background:rgba(124,92,255,.22);border-color: rgba(124,92,255,.35)}
    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background: rgba(15,22,38,.65);
      border-radius:16px;
      padding:14px;
    }
    .titleRow{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    h1{margin:0;font-size:18px}
    .small{color:var(--muted);font-size:12px;line-height:1.6}
    video{
      width:100%;
      max-height:70vh;
      border-radius:16px;
      background:#000;
      border:1px solid var(--border);
      outline:none;
    }
    iframe{
      width:100%;
      height:70vh;
      border-radius:16px;
      border:1px solid var(--border);
      background:#000;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;border-radius:999px;
      width:fit-content;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .codeBox{
      margin-top:12px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.55);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="row">
        <a class="btn ghost" href="/browse.html">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙƒØªØ¨Ø©</a>
        <span class="badge" id="typeBadge">Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
      </div>
      <div class="row">
        <button class="btn" onclick="toggleSubtitles()">CC</button>
        <button class="btn" onclick="reloadPlayer()">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
      </div>
    </div>

    <div class="panel">
      <div class="titleRow">
        <div>
          <h1 id="pageTitle">...</h1>
          <div class="small" id="pageSub">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„</div>
        </div>
      </div>

      <!-- Players -->
      <div id="playerArea">
        <video id="video" controls playsinline></video>
      </div>

      <div class="small" id="subsInfo" style="margin-top:10px;"></div>

      <!-- Optional: clickable copy box for code (if you still use it) -->
      <div class="codeBox" id="copyBox" style="display:none" onclick="copyText()">
        <div>
          <div class="small">Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø®</div>
          <div class="mono" id="copyValue"></div>
        </div>
        <div class="btn primary" style="pointer-events:none">Ù†Ø³Ø®</div>
      </div>
    </div>
  </div>

  <script>
    let hlsInstance = null;

    function qs(name){
      return new URLSearchParams(location.search).get(name) || "";
    }

    function setTitle(main, sub){
      document.getElementById("pageTitle").textContent = main || "Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
      document.getElementById("pageSub").textContent = sub || "";
      document.title = main ? ("Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© | " + main) : "Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
    }

    function setBadge(text){
      document.getElementById("typeBadge").textContent = text || "Ù…Ø´Ø§Ù‡Ø¯Ø©";
    }

    function setSubsInfo(text){
      document.getElementById("subsInfo").textContent = text || "";
    }

    function clearHls(){
      if (hlsInstance) {
        try { hlsInstance.destroy(); } catch(e) {}
        hlsInstance = null;
      }
    }

    function base64PayloadToJson(p){
      // payload was created using: btoa(unescape(encodeURIComponent(JSON.stringify(obj))))
      const json = decodeURIComponent(escape(atob(p)));
      return JSON.parse(json);
    }

    function ensureVideo(){
      const area = document.getElementById("playerArea");
      area.innerHTML = `<video id="video" controls playsinline></video>`;
      return document.getElementById("video");
    }

    function ensureIframe(src){
      const area = document.getElementById("playerArea");
      area.innerHTML = `<iframe src="${src}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    }

    function loadHls(videoEl, src){
      clearHls();

      // remove old tracks
      [...videoEl.querySelectorAll("track")].forEach(t => t.remove());

      if (window.Hls && Hls.isSupported()) {
        hlsInstance = new Hls({ enableWorker: true, lowLatencyMode: true });
        hlsInstance.loadSource(src);
        hlsInstance.attachMedia(videoEl);

        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
          if (data && data.fatal) {
            console.error("HLS fatal error:", data);
            alert("ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ø­Ù…ÙŠ Ø£Ùˆ ÙŠÙ…Ù†Ø¹ CORS.");
          }
        });
      } else if (videoEl.canPlayType("application/vnd.apple.mpegurl")) {
        // Safari
        videoEl.src = src;
      } else {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ m3u8 Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².");
      }
    }

    function addSubtitleTracks(videoEl, subs){
      // subs: [{lang,label,url}]
      if (!subs || !subs.length) {
        setSubsInfo("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±Ø¬Ù…Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø©");
        return;
      }

      subs.forEach((s, idx) => {
        const track = document.createElement("track");
        track.kind = "subtitles";
        track.label = s.label || `SUB ${idx+1}`;
        track.srclang = s.lang || `s${idx+1}`;
        track.src = s.url;
        track.default = idx === 0;
        videoEl.appendChild(track);
      });

      setSubsInfo(`âœ… Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ù…ØªØ§Ø­Ø© (${subs.length}) â€” Ø§ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© CC Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´ØºÙ„`);
    }

    function parseSpecialSrc(src){
      // Bunny embed: bunny:LIBID:VIDEOID
      if (src.startsWith("bunny:")) {
        const parts = src.split(":");
        return { kind: "bunny", lib: parts[1], id: parts[2] };
      }

      // Dailymotion:
      // dailymotion:x8l1rp8 OR full geo link
      if (src.startsWith("dailymotion:")) {
        return { kind: "dailymotion", id: src.split(":")[1] };
      }

      if (src.includes("geo.dailymotion.com/player.html?video=")) {
        const u = new URL(src);
        return { kind: "dailymotion-full", url: u.toString() };
      }

      return { kind: "hls", url: src };
    }

    function boot(){
      const type = qs("type");
      const title = qs("title");
      const series = qs("series");
      const ep = qs("ep");
      const src = qs("src");
      const payload = qs("payload");

      // default copy box hidden (only if you still want it somewhere)
      document.getElementById("copyBox").style.display = "none";

      // FOREIGN EP (payload contains {hlsUrl, subs[]})
      if (type === "foreign-ep") {
        setBadge("Ù…Ø³Ù„Ø³Ù„ Ø£Ø¬Ù†Ø¨ÙŠ");
        setTitle(series || "Ù…Ø³Ù„Ø³Ù„ Ø£Ø¬Ù†Ø¨ÙŠ", ep || "");
        const epObj = base64PayloadToJson(payload);

        const video = ensureVideo();
        addSubtitleTracks(video, epObj.subs || []);
        loadHls(video, epObj.hlsUrl);
        return;
      }

      // ARABIC SERIES EP (src is m3u8)
      if (type === "series-ep") {
        setBadge("Ù…Ø³Ù„Ø³Ù„");
        setTitle(series || "Ù…Ø³Ù„Ø³Ù„", ep || "");
        const video = ensureVideo();
        setSubsInfo(""); // no subs by default
        loadHls(video, src);
        return;
      }

      // FILM
      if (type === "film") {
        setBadge("ÙÙŠÙ„Ù…");
        setTitle(title || "ÙÙŠÙ„Ù…", "");

        const info = parseSpecialSrc(src);

        if (info.kind === "bunny") {
          // Bunny iframe embed
          const embed = `https://player.mediadelivery.net/embed/${info.lib}/${info.id}`;
          ensureIframe(embed);
          setSubsInfo("");
          return;
        }

        if (info.kind === "dailymotion") {
          const dm = `https://geo.dailymotion.com/player.html?video=${encodeURIComponent(info.id)}`;
          ensureIframe(dm);
          setSubsInfo("");
          return;
        }

        if (info.kind === "dailymotion-full") {
          ensureIframe(info.url);
          setSubsInfo("");
          return;
        }

        // normal HLS film
        const video = ensureVideo();
        setSubsInfo("");
        loadHls(video, info.url);
        return;
      }

      // fallback
      setBadge("Ù…Ø´Ø§Ù‡Ø¯Ø©");
      setTitle("Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©", "Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ØµÙØ­Ø©");
      setSubsInfo("âš ï¸ Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©.");
    }

    // ====== buttons ======
    function toggleSubtitles(){
      const video = document.getElementById("video");
      if (!video) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");

      const tracks = video.textTracks;
      if (!tracks || !tracks.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±Ø¬Ù…Ø§Øª.");

      // toggle first track
      const t = tracks[0];
      t.mode = (t.mode === "showing") ? "disabled" : "showing";
      alert(t.mode === "showing" ? "ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø©" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø¬Ù…Ø©");
    }

    function reloadPlayer(){
      location.reload();
    }

    function copyText(){
      const val = document.getElementById("copyValue").textContent || "";
      if (!val) return;

      navigator.clipboard.writeText(val).then(()=>{
        alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
      }).catch(()=>{
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
      });
    }

    // Start
    boot();
  </script>
</body>
</html>
