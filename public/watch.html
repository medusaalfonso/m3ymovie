<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>المشاهدة</title>

  <style>
    :root{
      --bg:#0b0e14;
      --panel:#111624;
      --text:#e8ecf5;
      --muted:#9aa4b2;
      --accent:#6ea8fe;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Arabic", sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(110,168,254,.18), transparent 60%), var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 24px;
    }

    .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .title{
      font-size: 16px;
      color: var(--text);
      font-weight: 700;
      line-height: 1.4;
      margin:0;
      opacity:.95;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin:0;
    }

    .playerCard{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .ratio{
      position:relative;
      width:100%;
      padding-top: 56.25%; /* 16:9 */
      background:#000;
    }

    video, iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      background:#000;
    }

    video{
      outline:none;
    }

    /* Make captions a bit smaller */
    video::cue {
      font-size: 0.85em;
      line-height: 1.2;
    }

    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      background: rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: .2s ease;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }

    .btn{
      appearance:none;
      border:0;
      background: var(--accent);
      color:#061022;
      font-weight:800;
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(110,168,254,.25);
    }
    .btn:active{transform: translateY(1px)}

    .small{
      font-size:12px;
      color: rgba(255,255,255,.8);
      max-width: 90%;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 id="pageTitle" class="title">المشاهدة</h1>
        <p id="pageHint" class="hint"></p>
      </div>
    </div>

    <div class="playerCard">
      <div class="ratio">
        <video id="video" controls playsinline preload="metadata" style="display:none" crossorigin="anonymous"></video>
        <iframe id="bunnyFrame" style="display:none" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>

        <div id="overlay" class="overlay show">
          <button id="overlayPlay" class="btn">تشغيل</button>
          <div id="overlayMsg" class="small"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
(() => {
  const params = new URLSearchParams(location.search);

  // Prefer id-based playback (hides real URL), fallback to src if needed.
  const type = (params.get("type") || "").toLowerCase(); // bunny | hls
  const id = params.get("id"); // your internal id (recommended)
  const src = params.get("src"); // direct URL fallback
  const title = params.get("title") || "المشاهدة";
  const poster = params.get("poster") || "";

  // Optional subtitles:
  // - subs JSON can be passed in localStorage by key: subkey
  // - or as direct "sub" param (single vtt)
  const subkey = params.get("subkey"); // localStorage key holding subs array
  const directSub = params.get("sub"); // direct vtt URL (single)

  const video = document.getElementById("video");
  const frame = document.getElementById("bunnyFrame");
  const pageTitle = document.getElementById("pageTitle");
  const hint = document.getElementById("pageHint");
  const overlay = document.getElementById("overlay");
  const overlayPlay = document.getElementById("overlayPlay");
  const overlayMsg = document.getElementById("overlayMsg");

  pageTitle.textContent = title;

  let hls = null;

  function showOverlay(message) {
    overlayMsg.textContent = message || "";
    overlay.classList.add("show");
  }
  function hideOverlay() {
    overlay.classList.remove("show");
    overlayMsg.textContent = "";
  }

  function setPoster() {
    if (poster) {
      video.setAttribute("poster", poster);
    }
  }

  function parseSubs() {
    let subs = [];
    try {
      if (subkey) {
        const raw = localStorage.getItem(subkey);
        if (raw) subs = JSON.parse(raw);
      }
    } catch (e) {}

    if (directSub) {
      subs = [{ lang: "ar", label: "Arabic", url: directSub }];
    }

    // normalize (some catalogs use s1/s2...)
    subs = Array.isArray(subs) ? subs : [];
    return subs
      .filter(s => s && s.url)
      .map((s, i) => ({
        lang: (s.lang || `s${i+1}`).toString(),
        label: (s.label || `SUB ${i+1}`).toString(),
        url: s.url.toString()
      }));
  }

  function applyTracks(subs) {
    // remove old tracks
    [...video.querySelectorAll("track")].forEach(t => t.remove());

    subs.forEach((s, idx) => {
      const tr = document.createElement("track");
      tr.kind = "subtitles";
      tr.srclang = s.lang;
      tr.label = s.label;
      tr.src = s.url;
      tr.default = idx === 0;
      video.appendChild(tr);
    });

    // Make first track show by default if available
    try {
      if (video.textTracks && video.textTracks.length) {
        for (let i = 0; i < video.textTracks.length; i++) {
          video.textTracks[i].mode = (i === 0) ? "showing" : "disabled";
        }
      }
    } catch (e) {}
  }

  async function fetchPlaybackById() {
    // You should already have a netlify function or endpoint that returns:
    // { type: "bunny"|"hls", src: "...", poster: "...", title:"...", subs:[...] }
    // If you don't have it, keep using src in URL.
    const url = `/.netlify/functions/play?id=${encodeURIComponent(id)}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("PLAYBACK_FETCH_FAILED");
    return await res.json();
  }

  function startBunny(embedUrl) {
    video.style.display = "none";
    frame.style.display = "block";

    // Bunny embed must be allowed in CSP (frame-src)
    frame.src = embedUrl;

    hideOverlay();
  }

  function startHls(hlsUrl) {
    frame.style.display = "none";
    frame.src = "about:blank";
    video.style.display = "block";

    setPoster();
    applyTracks(parseSubs());

    if (hls) { try { hls.destroy(); } catch(e) {} hls = null; }

    // Try native HLS first (Safari/iOS)
    if (video.canPlayType("application/vnd.apple.mpegurl")) {
      video.src = hlsUrl;
    } else if (window.Hls && Hls.isSupported()) {
      hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true
      });
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
    } else {
      showOverlay("المتصفح لا يدعم HLS");
      return;
    }

    hideOverlay();
  }

  async function autoPlayBestEffort() {
    // Autoplay with sound is usually blocked by browsers.
    // We'll attempt: play() -> if blocked, keep overlay visible.
    try {
      const p = video.play();
      if (p && typeof p.then === "function") await p;
    } catch (e) {
      showOverlay("اضغط تشغيل");
    }
  }

  overlayPlay.addEventListener("click", async () => {
    hideOverlay();
    try {
      // If we are on video:
      if (video.style.display !== "none") {
        await video.play();
      }
    } catch (e) {
      showOverlay("اضغط تشغيل");
    }
  });

  async function init() {
    showOverlay("جاري التحميل...");

    let playback = null;

    if (id) {
      playback = await fetchPlaybackById();
    } else {
      // fallback from URL params
      playback = { type, src, poster, title, subs: null };
    }

    if (!playback || !playback.src) {
      showOverlay("رابط غير صالح");
      return;
    }

    // Update title/poster if provided by server
    if (playback.title) pageTitle.textContent = playback.title;
    if (playback.poster) video.setAttribute("poster", playback.poster);

    // If server provides subs, store them into localStorage under subkey (if present) then load
    if (Array.isArray(playback.subs) && playback.subs.length && subkey) {
      try { localStorage.setItem(subkey, JSON.stringify(playback.subs)); } catch (e) {}
    }

    const t = (playback.type || type || "").toLowerCase();

    if (t === "bunny") {
      startBunny(playback.src);
      // iframe autoplay is controlled by Bunny + browser policies.
      hideOverlay();
      return;
    }

    // default to hls
    startHls(playback.src);
    await autoPlayBestEffort();
  }

  init().catch(() => {
    showOverlay("حدث خطأ أثناء التشغيل");
  });

  // ===============================
  // Anti-recording / anti-capture (best-effort, not foolproof)
  // ===============================
  function stopPlayback(reason) {
    try { if (!video.paused) video.pause(); } catch (e) {}
    try { if (hls) { hls.destroy(); hls = null; } } catch (e) {}
    try { if (frame && frame.style.display !== 'none') { frame.src = 'about:blank'; } } catch (e) {}

    try {
      hint.textContent = reason || "تم إيقاف التشغيل";
      overlay.classList.add("show");
    } catch (e) {}
  }

  /* 2️⃣ تغيّر أجهزة الوسائط (OBS / Bandicam audio devices) */
  if (navigator.mediaDevices) {
    navigator.mediaDevices.ondevicechange = () => {
      stopPlayback("تم اكتشاف جهاز وسائط جديد");
    };
  }

  /* 3️⃣ كشف هبوط الأداء (FPS drop) */
  let last = performance.now();
  function fpsMonitor(now) {
    if (now - last > 120) {
      stopPlayback("انخفاض مفاجئ في الأداء (احتمال تسجيل)");
      return;
    }
    last = now;
    requestAnimationFrame(fpsMonitor);
  }
  requestAnimationFrame(fpsMonitor);

  /* 4️⃣ تعطيل Picture-in-Picture */
  document.addEventListener("enterpictureinpicture", e => {
    e.preventDefault();
    stopPlayback("محاولة Picture-in-Picture");
  });

  /* 5️⃣ حظر اختصارات شائعة */
  document.addEventListener("keydown", e => {
    if (
      e.key === "F12" ||
      (e.ctrlKey && ["S","I","J","U"].includes(e.key.toUpperCase()))
    ) {
      e.preventDefault();
    }
  });

})();
  </script>
</body>
</html>
