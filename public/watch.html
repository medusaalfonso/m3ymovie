<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشاهدة</title>
  <link rel="stylesheet" href="style.css">
  <!-- HLS.js for HLS streams -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0a0a0a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
    }

    .video-container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .player-wrapper {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .player-wrapper.aspect-16-9 {
      aspect-ratio: 16/9;
    }

    /* HLS Video Player */
    #hls-player {
      width: 100%;
      height: 100%;
      display: none;
    }

    #hls-player.active {
      display: block;
    }

    /* Bunny CDN Player */
    #bunny-player {
      width: 100%;
      height: 100%;
      display: none;
      border: none;
    }

    #bunny-player.active {
      display: block;
    }

    /* Videas.fr Player */
    #videas-player {
      width: 100%;
      height: 100%;
      display: none;
      border: none;
    }

    #videas-player.active {
      display: block;
    }

    /* OK.ru Player */
    #okru-player {
      width: 100%;
      height: 100%;
      display: none;
      border: none;
    }

    #okru-player.active {
      display: block;
    }

    .video-info {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .video-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .video-meta {
      display: flex;
      gap: 15px;
      font-size: 14px;
      color: #999;
    }

    .cdn-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .cdn-badge.bunny {
      background: #ff6b35;
      color: white;
    }

    .cdn-badge.videas {
      background: #4a90e2;
      color: white;
    }

    .cdn-badge.okru {
      background: #ee8208;
      color: white;
    }

    .cdn-badge.hls {
      background: #28a745;
      color: white;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #ff4444;
      padding: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
      max-width: 80%;
    }

    .back-btn {
      display: inline-block;
      margin: 20px 0;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
      .video-container {
        padding: 10px;
      }

      .video-title {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="video-container">
    <a href="/browse.html" class="back-btn">← العودة للمكتبة</a>

    <div class="player-wrapper aspect-16-9" id="playerWrapper">
      <!-- Loading indicator -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>جاري التحميل...</div>
      </div>

      <!-- HLS Video Player (for .m3u8 streams) -->
      <video id="hls-player" controls playsinline></video>

      <!-- Bunny CDN Player -->
      <iframe 
        id="bunny-player"
        allowfullscreen
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share">
      </iframe>

      <!-- Videas.fr Player -->
      <iframe 
        id="videas-player"
        allowfullscreen
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share">
      </iframe>

      <!-- OK.ru Player -->
      <iframe 
        id="okru-player"
        allowfullscreen
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share">
      </iframe>
    </div>

    <div class="video-info" id="videoInfo" style="display: none;">
      <div class="video-title" id="videoTitle"></div>
      <div class="video-meta">
        <span class="cdn-badge" id="cdnBadge"></span>
      </div>
    </div>
  </div>

  <script>
    // Get video ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('id');

    if (!videoId) {
      showError('معرف الفيديو مفقود');
    } else {
      loadVideo(videoId);
    }

    async function loadVideo(id) {
      try {
        const response = await fetch(`/.netlify/functions/stream?id=${id}`);
        
        if (!response.ok) {
          throw new Error('فشل في تحميل الفيديو');
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Hide loading
        document.getElementById('loading').style.display = 'none';

        // Show video info
        document.getElementById('videoInfo').style.display = 'block';
        document.getElementById('videoTitle').textContent = data.title || 'بدون عنوان';

        // Initialize the appropriate player based on video kind
        switch (data.kind) {
          case 'videas_embed':
            initVideasPlayer(data.url);
            updateCDNBadge('videas', 'Videas.fr');
            break;
          
          case 'okru_embed':
            initOkRuPlayer(data.url);
            updateCDNBadge('okru', 'OK.ru');
            break;
          
          case 'bunny_embed':
            initBunnyPlayer(data.url);
            updateCDNBadge('bunny', 'Bunny CDN');
            break;
          
          case 'hls':
          case 'mp4':
          default:
            initHLSPlayer(data.url);
            updateCDNBadge('hls', data.kind.toUpperCase());
            break;
        }

      } catch (error) {
        console.error('Error loading video:', error);
        showError(error.message || 'حدث خطأ أثناء تحميل الفيديو');
      }
    }

    function initVideasPlayer(embedUrl) {
      const iframe = document.getElementById('videas-player');
      iframe.src = embedUrl;
      iframe.classList.add('active');
      
      console.log('Videas.fr player initialized:', embedUrl);
    }

    function initOkRuPlayer(embedUrl) {
      const iframe = document.getElementById('okru-player');
      iframe.src = embedUrl;
      iframe.classList.add('active');
      
      console.log('OK.ru player initialized:', embedUrl);
    }

    function initBunnyPlayer(embedUrl) {
      const iframe = document.getElementById('bunny-player');
      
      // If it's just a GUID, construct the full Bunny embed URL
      const guidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
      if (guidPattern.test(embedUrl)) {
        iframe.src = `https://iframe.mediadelivery.net/embed/YOUR_LIBRARY_ID/${embedUrl}`;
      } else {
        iframe.src = embedUrl;
      }
      
      iframe.classList.add('active');
      
      console.log('Bunny CDN player initialized:', iframe.src);
    }

    function initHLSPlayer(videoUrl) {
      const video = document.getElementById('hls-player');
      video.classList.add('active');

      // Check if HLS.js is supported
      if (Hls.isSupported()) {
        const hls = new Hls({
          autoStartLoad: true,
          startPosition: -1,
          debug: false,
          enableWorker: true,
          lowLatencyMode: true,
        });

        hls.loadSource(videoUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          console.log('HLS manifest parsed, starting playback');
          video.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
          });
        });

        hls.on(Hls.Events.ERROR, function (event, data) {
          console.error('HLS error:', data);
          
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.log('Network error, attempting to recover...');
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.log('Media error, attempting to recover...');
                hls.recoverMediaError();
                break;
              default:
                showError('خطأ فادح في تشغيل الفيديو');
                hls.destroy();
                break;
            }
          }
        });

        // Store HLS instance for cleanup
        window.hlsInstance = hls;
      }
      // Fallback for Safari (native HLS support)
      else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoUrl;
        video.addEventListener('loadedmetadata', function () {
          console.log('Native HLS loaded');
          video.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
          });
        });

        video.addEventListener('error', function () {
          showError('خطأ في تشغيل الفيديو');
        });
      } else {
        showError('المتصفح لا يدعم تشغيل هذا النوع من الفيديو');
      }

      console.log('HLS player initialized:', videoUrl);
    }

    function updateCDNBadge(type, label) {
      const badge = document.getElementById('cdnBadge');
      badge.className = `cdn-badge ${type}`;
      badge.textContent = label;
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `
        <h3>⚠️ خطأ</h3>
        <p>${message}</p>
        <a href="/browse.html" class="back-btn">العودة للمكتبة</a>
      `;
      
      document.getElementById('playerWrapper').appendChild(errorDiv);
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (window.hlsInstance) {
        window.hlsInstance.destroy();
      }
    });
  </script>
</body>
</html>
