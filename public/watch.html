<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1626;
      --card2:#121c30;
      --text:#e7ecff;
      --muted:#a8b2d1;
      --border:rgba(255,255,255,.10);
      --accent:#7c5cff;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1100px 700px at 80% 10%, rgba(124,92,255,.16), transparent 60%),
                  radial-gradient(900px 500px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      direction: rtl;
    }
    .container{max-width:1150px;margin:0 auto;padding:22px}
    .nav{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 18px;border:1px solid var(--border);
      background:rgba(15,22,38,.7);backdrop-filter: blur(10px);
      border-radius:16px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,197,94,.75));
      box-shadow: 0 12px 40px rgba(124,92,255,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;color:var(--muted);font-size:12px}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(18,28,48,.7);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{border-color: rgba(124,92,255,.45)}
    .btn.primary{background:rgba(124,92,255,.22);border-color: rgba(124,92,255,.35)}

    .layout{display:grid;grid-template-columns: 1.6fr .8fr;gap:16px;margin-top:16px}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,48,.75), rgba(15,22,38,.85));
      border-radius:18px;
      padding:14px;
      box-shadow: 0 16px 60px rgba(0,0,0,.32);
    }

    .titleRow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .titleRow h2{margin:0;font-size:18px;line-height:1.5}
    .small{color:var(--muted);font-size:12px;line-height:1.7}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;border-radius:999px;
      width:fit-content;
    }

    .playerWrap{margin-top:12px;border-radius:16px;overflow:hidden;border:1px solid var(--border);background:#000}
    video{width:100%;height:auto;display:block;background:#000}

    .posterBox{
      display:flex;gap:12px;align-items:flex-start;
    }
    .poster{
      width:92px;aspect-ratio:2/3;border-radius:14px;overflow:hidden;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      flex:0 0 auto;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .row .btn{flex:0 0 auto}

    .err{
      margin-top:10px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color:#ffd6d6;
      padding:10px 12px;border-radius:14px;
      display:none;
    }

    .ok{
      margin-top:10px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
      color:#d7ffe7;
      padding:10px 12px;border-radius:14px;
      display:none;
    }

    .trackList{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .trackItem{
      border:1px solid var(--border);
      background: rgba(18,28,48,.55);
      padding:10px 12px;
      border-radius:14px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h1>
          <p id="subTitle">Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/browse.html">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙƒØªØ¨Ø©</a>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: player -->
      <div class="panel">
        <div class="titleRow">
          <h2 id="title">...</h2>
          <span class="badge" id="typeBadge">HLS</span>
        </div>
        <div class="small" id="meta">â€”</div>

        <div class="playerWrap">
          <video id="video" controls playsinline crossorigin="anonymous"></video>
        </div>

        <div class="row">
          <button class="btn" onclick="toggleSubtitles()">ğŸ“ ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø¬Ù…Ø©</button>
          <button class="btn" onclick="makeFullscreen()">â›¶ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
          <button class="btn primary" onclick="retry()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
        </div>

        <div class="ok" id="okBox"></div>
        <div class="err" id="errBox"></div>
      </div>

      <!-- RIGHT: info -->
      <div class="panel">
        <div class="posterBox">
          <div class="poster"><img id="poster" alt="poster"></div>
          <div>
            <div class="badge">ğŸï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
            <div class="small" style="margin-top:8px">
              Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:
              <br>â€¢ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· <span class="mono">m3u8</span> ØµØ­ÙŠØ­
              <br>â€¢ Ø¨Ø¹Ø¶ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØªÙ…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø³Ø¨Ø¨ CORS
              <br>â€¢ Ø¬Ø±Ù‘Ø¨ Ø±Ø§Ø¨Ø· Ù…Ø®ØªÙ„Ù Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Bunny player embed
            </div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="badge">ğŸ—‚ï¸ Ø§Ù„ØªØ±Ø¬Ù…Ø©</div>
          <div class="trackList" id="trackList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>

  <script>
    const PLACEHOLDER = "https://via.placeholder.com/600x900?text=Poster";

    const video = document.getElementById("video");
    const titleEl = document.getElementById("title");
    const metaEl = document.getElementById("meta");
    const typeBadge = document.getElementById("typeBadge");
    const posterEl = document.getElementById("poster");
    const trackListEl = document.getElementById("trackList");
    const okBox = document.getElementById("okBox");
    const errBox = document.getElementById("errBox");

    let hls = null;
    let lastSrc = null;

    function showOk(msg){
      okBox.style.display = "block";
      okBox.textContent = msg;
    }
    function hideOk(){ okBox.style.display = "none"; okBox.textContent = ""; }

    function showErr(msg){
      errBox.style.display = "block";
      errBox.textContent = msg;
    }
    function hideErr(){ errBox.style.display = "none"; errBox.textContent = ""; }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Parse subtitles from URL:
    // ?sub=<url>|<label>|<lang>|<isDefault>
    function parseSubsFromQuery(params){
      const subs = params.getAll("sub");
      const tracks = [];

      for (const raw of subs){
        const parts = String(raw).split("|");
        const url = (parts[0] || "").trim();
        if (!url) continue;

        const label = (parts[1] || "Subtitles").trim();
        const lang  = (parts[2] || "en").trim();
        const isDefault = (parts[3] || "0").trim() === "1";

        tracks.push({ url, label, lang, isDefault });
      }

      return tracks;
    }

    function clearTracks(){
      // remove <track> from DOM
      [...video.querySelectorAll("track")].forEach(t => t.remove());
      trackListEl.innerHTML = "";
    }

    function addTracks(tracks){
      clearTracks();

      if (!tracks.length){
        trackListEl.innerHTML = `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±Ø¬Ù…Ø© Ù…Ø¶Ø§ÙØ©.</div>`;
        return;
      }

      tracks.forEach((t, idx) => {
        const track = document.createElement("track");
        track.kind = "subtitles";
        track.label = t.label;
        track.srclang = t.lang;
        track.src = t.url;

        // default track
        if (t.isDefault) track.default = true;

        video.appendChild(track);

        const row = document.createElement("div");
        row.className = "trackItem";
        row.innerHTML = `
          <div>
            <div>${escapeHtml(t.label)} <span class="small">(${escapeHtml(t.lang)})</span></div>
            <div class="small mono" style="direction:ltr;text-align:left;word-break:break-all">${escapeHtml(t.url)}</div>
          </div>
          <button class="btn" onclick="selectSubtitle(${idx})">Ø§Ø®ØªÙŠØ§Ø±</button>
        `;
        trackListEl.appendChild(row);
      });

      // Force browser to re-evaluate tracks
      setTimeout(() => {
        // if there is default track, enable it
        const textTracks = video.textTracks;
        let chosen = -1;
        for (let i=0;i<textTracks.length;i++){
          if (tracks[i] && tracks[i].isDefault) { chosen = i; break; }
        }
        if (chosen >= 0) {
          selectSubtitle(chosen);
        } else {
          // turn them off by default (you can change this behavior)
          for (let i=0;i<textTracks.length;i++) textTracks[i].mode = "disabled";
        }
      }, 200);
    }

    // Select one subtitle track by index
    window.selectSubtitle = function(i){
      const tt = video.textTracks;
      for (let k=0;k<tt.length;k++){
        tt[k].mode = (k === i) ? "showing" : "disabled";
      }
      showOk("âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø©: " + (tt[i]?.label || ""));
      setTimeout(hideOk, 2200);
    };

    window.toggleSubtitles = function(){
      const tt = video.textTracks;
      if (!tt || tt.length === 0){
        showErr("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±Ø¬Ù…Ø©.");
        setTimeout(hideErr, 2200);
        return;
      }
      // if any showing -> disable all, else show first
      let anyShowing = false;
      for (let i=0;i<tt.length;i++){
        if (tt[i].mode === "showing") { anyShowing = true; break; }
      }
      for (let i=0;i<tt.length;i++){
        tt[i].mode = anyShowing ? "disabled" : (i===0 ? "showing" : "disabled");
      }
      showOk(anyShowing ? "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø¬Ù…Ø©" : "ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø©");
      setTimeout(hideOk, 2200);
    };

    window.makeFullscreen = function(){
      const el = video;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    };

    function destroyHls(){
      if (hls){
        try{ hls.destroy(); }catch(e){}
        hls = null;
      }
    }

    function isProbablyM3U8(url){
      return /\.m3u8(\?|$)/i.test(url) || url.includes("application/vnd.apple.mpegurl");
    }

    function loadHls(src){
      destroyHls();

      lastSrc = src;

      // If browser supports native HLS (Safari), use it.
      if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = src;
        return;
      }

      if (!window.Hls || !Hls.isSupported()){
        throw new Error("HLS.js ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­");
      }

      hls = new Hls({
        enableWorker: true,
        lowLatencyMode: false,
        backBufferLength: 90
      });

      hls.on(Hls.Events.ERROR, function (event, data) {
        // Common reason: CORS blocked, 403, etc.
        if (data && data.fatal) {
          showErr("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ HLS. Ù…Ù…ÙƒÙ† Ø§Ù„Ø³Ø¨Ø¨: CORS / Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ / Ù…Ù†Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.");
        }
      });

      hls.loadSource(src);
      hls.attachMedia(video);
    }

    function setPageInfo(params){
      const t = params.get("title") || "Ù…Ø´Ø§Ù‡Ø¯Ø©";
      const type = params.get("type") || "hls";
      const series = params.get("series") || "";
      const ep = params.get("ep") || "";

      titleEl.textContent = t;

      let meta = [];
      if (series) meta.push("Ø§Ù„Ù…Ø³Ù„Ø³Ù„: " + series);
      if (ep) meta.push("Ø§Ù„Ø­Ù„Ù‚Ø©: " + ep);
      metaEl.textContent = meta.length ? meta.join(" â€¢ ") : "â€”";

      typeBadge.textContent = (type || "HLS").toUpperCase();
      posterEl.src = params.get("poster") || PLACEHOLDER;
    }

    function loadFromUrl(){
      hideErr(); hideOk();

      const params = new URLSearchParams(location.search);
      const src = params.get("src");

      setPageInfo(params);

      if (!src){
        showErr("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„ØµÙØ­Ø© (src).");
        return;
      }

      const tracks = parseSubsFromQuery(params);
      addTracks(tracks);

      // Decide load method
      if (isProbablyM3U8(src)){
        try{
          loadHls(src);
          showOk("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ m3u8");
          setTimeout(hideOk, 1600);
        }catch(e){
          showErr("âŒ " + (e.message || String(e)));
        }
      } else {
        // fallback: mp4 or other direct
        destroyHls();
        lastSrc = src;
        video.src = src;
        showOk("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
        setTimeout(hideOk, 1600);
      }
    }

    window.retry = function(){
      if (!lastSrc){
        loadFromUrl();
        return;
      }
      loadFromUrl();
    };

    // Show errors from <video>
    video.addEventListener("error", () => {
      showErr("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ù…Ù…ÙƒÙ† Ø§Ù„Ø³Ø¨Ø¨: Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø£Ùˆ CORS.");
    });

    // Start
    loadFromUrl();
  </script>
</body>
</html>
