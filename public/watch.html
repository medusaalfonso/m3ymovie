<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>المشاهدة</title>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>

  <style>
    :root{
      --bg:#0b0f17; --panel:#0f1624; --text:#e8eefc; --muted:#9db0d1;
      --border:rgba(255,255,255,.08); --shadow:0 12px 40px rgba(0,0,0,.45);
      --accent:#7c5cff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 50% -100px, rgba(124,92,255,.25), transparent 65%),
                  linear-gradient(180deg, #070a10, var(--bg));
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(11,15,23,.7);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .bar{
      max-width:1100px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .back{
      appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .back:hover{border-color:rgba(124,92,255,.4)}
    .titleWrap{min-width:0}
    h1{
      margin:0; font-size:16px; font-weight:800; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sub{
      margin-top:2px; font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    main{max-width:1100px; margin:0 auto; padding:16px;}
    .playerCard{
      background: rgba(15,22,36,.75);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .playerTop{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .err{
      display:none;
      padding:12px 14px;
      border-top:1px solid var(--border);
      background: rgba(255,70,70,.08);
      color:#ffd7d7;
      font-size:13px;
      line-height:1.5;
    }

    .playerWrap{background:#000}
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    iframe{
      display:block;
      width:100%;
      aspect-ratio:16/9;
      border:0;
      background:#000;
    }

    .hint{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.7;
    }
    code{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding:2px 6px;
      border-radius:8px;
    }
  </style>
</head>

<body>
  <header>
    <div class="bar">
      <button class="back" onclick="history.back()">⬅ رجوع</button>
      <div class="titleWrap">
        <h1 id="pageTitle">المشاهدة</h1>
        <div class="sub" id="pageSub">—</div>
      </div>
    </div>
  </header>

  <main>
    <div class="playerCard">
      <div class="playerTop">
        <div class="pill" id="modePill">—</div>
        <div class="pill" id="srcPill">—</div>
      </div>

      <div class="playerWrap" id="playerWrap">
        <video id="video" controls playsinline crossorigin="anonymous" style="display:none"></video>

        <iframe
          id="bunnyFrame"
          title="Bunny Player"
          style="display:none"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
        ></iframe>
      </div>

      <div class="err" id="errBox"></div>
    </div>

    <div class="hint">
      ✅ يدعم تشغيل <code>.m3u8</code> باستخدام hls.js + ترجمة <code>.vtt</code> من روابط خارجية.<br>
      ⚠️ إذا لم يعمل m3u8 في المتصفح غالباً السبب هو <b>CORS</b> (سيظهر الخطأ في الكونسول).<br>
      ✅ Bunny embed يعمل عبر <code>iframe</code> ويحتاج سماح <code>frame-src</code> في CSP (ملف netlify.toml بالأسفل).
    </div>
  </main>

<script>
  const $ = (id) => document.getElementById(id);

  const video = $("video");
  const iframe = $("bunnyFrame");
  const errBox = $("errBox");
  const modePill = $("modePill");
  const srcPill = $("srcPill");

  let hls = null;

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function destroyHls(){
    try{ if(hls){ hls.destroy(); } }catch(e){}
    hls = null;
  }

  function resetPlayers(){
    clearErr();
    destroyHls();

    // reset iframe
    iframe.src = "about:blank";
    iframe.style.display = "none";

    // reset video
    try{ video.pause(); }catch(e){}
    video.removeAttribute("src");
    // remove tracks
    [...video.querySelectorAll("track")].forEach(t => t.remove());
    video.load();
    video.style.display = "none";
  }

  function setMeta({title, sub, mode, srcLabel}){
    $("pageTitle").textContent = title || "المشاهدة";
    $("pageSub").textContent = sub || "—";
    modePill.textContent = mode || "—";
    srcPill.textContent = srcLabel || "—";
  }

  function isBunnyEmbed(url){
    try{
      const u = new URL(url);
      return u.hostname.includes("player.mediadelivery.net") && u.pathname.includes("/embed/");
    }catch(e){
      return false;
    }
  }

  function parseSubsFromParams(params){
    // sub param format: url|label|lang|default(0/1)
    const subs = params.getAll("sub") || [];
    return subs.map(s => {
      const parts = s.split("|");
      return {
        url: parts[0] || "",
        label: parts[1] || "SUB",
        lang: parts[2] || "en",
        isDefault: parts[3] === "1"
      };
    }).filter(x => x.url);
  }

  function attachVttTracks(subs){
    // remove any existing
    [...video.querySelectorAll("track")].forEach(t => t.remove());

    let hasDefault = subs.some(s => s.isDefault);
    subs.forEach((s, idx) => {
      const t = document.createElement("track");
      t.kind = "subtitles";
      t.label = s.label || `SUB ${idx+1}`;
      t.srclang = s.lang || `s${idx+1}`;
      t.src = s.url;
      t.default = hasDefault ? !!s.isDefault : (idx === 0);
      video.appendChild(t);
    });
  }

  function playBunny(embedUrl){
    resetPlayers();
    setMeta({
      title: new URLSearchParams(location.search).get("title") || "مشاهدة",
      sub: "Bunny Player",
      mode: "Bunny Embed",
      srcLabel: "player.mediadelivery.net"
    });

    iframe.style.display = "block";
    iframe.src = embedUrl;
  }

  function playHlsOrMp4(src, subs){
    resetPlayers();
    video.style.display = "block";

    const host = (() => {
      try { return new URL(src).hostname; } catch(e){ return "source"; }
    })();

    setMeta({
      title: new URLSearchParams(location.search).get("title") || "مشاهدة",
      sub: host,
      mode: src.includes(".m3u8") ? "HLS (m3u8)" : "Video (mp4/webm)",
      srcLabel: host
    });

    attachVttTracks(subs);

    // HLS
    if (src.includes(".m3u8")) {
      if (window.Hls && Hls.isSupported()) {
        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          console.log("HLS ERROR:", data);
          const code = data?.response?.code ? ("HTTP " + data.response.code) : "";
          showErr("HLS Error: " + (data?.details || "unknown") + (code ? (" | " + code) : ""));
        });

        hls.loadSource(src);
        hls.attachMedia(video);
      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
        // Safari iOS/macOS
        video.src = src;
      } else {
        showErr("المتصفح لا يدعم تشغيل m3u8 (HLS).");
      }
    } else {
      // normal mp4/webm
      video.src = src;
    }
  }

  // ---- Boot
  (function init(){
    const params = new URLSearchParams(location.search);
    const src = params.get("src") || "";
    const subs = parseSubsFromParams(params);

    if (!src) {
      resetPlayers();
      setMeta({ title: "المشاهدة", sub: "لا يوجد رابط", mode: "—", srcLabel: "—" });
      showErr("لا يوجد رابط فيديو. ارجع واختر فيلم/حلقة من جديد.");
      return;
    }

    if (isBunnyEmbed(src)) {
      playBunny(src);
      return;
    }

    // Default: HLS or mp4
    playHlsOrMp4(src, subs);
  })();
</script>
</body>
</html>
